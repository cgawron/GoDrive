/**
 * ngGo v1.1.1
 * https://github.com/AdamBuczynski/ngGo
 *
 * Copyright (c) 2015 Adam Buczynski
 */
!function(a,b,c){"use strict";function d(a){var b=0,c=0;return"detail"in a&&(c=-1*a.detail),"wheelDelta"in a&&(c=a.wheelDelta),"wheelDeltaY"in a&&(c=a.wheelDeltaY),"wheelDeltaX"in a&&(b=-1*a.wheelDeltaX),"axis"in a&&a.axis===a.HORIZONTAL_AXIS&&(b=-1*c,c=0),"deltaY"in a&&(c=-1*a.deltaY),"deltaX"in a&&(b=a.deltaX),a.mouseWheelX=b,a.mouseWheelY=c,a}b.module("ngGo.Board.Directive",["ngGo.Board.Service"]).directive("board",["$window","Board",function(c,d){var e=a.pixelRatio||1,f=function(a){var b=document.createElement("canvas"),c=b.getContext("2d");return e>1&&c.scale(e,e),b.className=a,b.width=this.clientWidth*e,b.height=this.clientHeight*e,this.appendChild(b),c},g=function(a,b,c){var d,e,f;return 0===c&&b>0&&(c=b),a.Board.width&&a.Board.height?(f=Math.min(b/a.Board.width,c/a.Board.height),d=Math.floor(f*a.Board.width),e=Math.floor(f*a.Board.height)):d=e=Math.min(b,c),a.lastDrawWidth!=d||a.lastDrawHeight!=e?(a.lastDrawWidth=d,a.lastDrawHeight=e,a.$broadcast("ngGo.board.drawSizeChanged",d,e),!0):!1};return{restrict:"E",scope:{instance:"&"},link:function(a,h,i){var j,k,l,m,n=h.parent(),o=h[0],p=!0;if(a.lastDrawWidth=0,a.lastDrawHeight=0,a.Board=a.instance(),"function"==typeof a.Board&&(a.Board=a.Board()),a.Board||(p=!1,a.Board=new d),a.Board.linkElement(h),"PLAYER"==n[0].tagName&&(m=n,o=n.parent()[0]),a.$on("ngGo.board.drawSizeChanged",function(b,c,d){var f=h.find("canvas");for(j=0;j<f.length;j++)f[j].width=c*e,f[j].height=d*e;(m||"true"===i.forceSize)&&h.css({width:c+"px",height:d+"px"}),a.Board.setDrawSize(c*e,d*e)}),g(a,o.clientWidth,o.clientHeight),b.element(c).on("resize",function(){g(a,o.clientWidth,o.clientHeight)}),a.$on("ngGo.board.determineDrawSize",function(){g(a,o.clientWidth,o.clientHeight)}),a.$on("ngGo.board.resize",function(b,c){c==a.Board&&(g(a,o.clientWidth,o.clientHeight)||a.Board.resized())}),i.static&&"true"===i.static)for(h.addClass("static"),a.Board.makeStatic(),k=f.call(h[0],"static"),j=0;j<a.Board.layerOrder.length;j++)l=a.Board.layerOrder[j],a.Board.layers[l].setContext(k);else for(j=0;j<a.Board.layerOrder.length;j++)l=a.Board.layerOrder[j],k=f.call(h[0],l),a.Board.layers[l].setContext(k);i.$observe("size",function(b){"string"==typeof b&&-1!==b.toLowerCase().indexOf("x")?(b=b.split("x"),a.Board.setSize(b[0],b[1])):a.Board.setSize(b,b)}),i.$observe("coordinates",function(b){a.Board.toggleCoordinates("true"===b)}),i.$observe("cutoff",function(c){b.isDefined(c)&&a.Board.setCutoff(c.split(","))}),i.$observe("colorMultiplier",function(c){b.isDefined(c)&&a.Board.swapColors(c)}),a.$parent.Player&&a.$parent.Player.setBoard(a.Board),p&&a.Board.redraw()}}}]),b.module("ngGo.Board.Service",["ngGo","ngGo.Board.Directive","ngGo.Board.Theme.Service","ngGo.Board.Layer.GridLayer.Service","ngGo.Board.Layer.ShadowLayer.Service","ngGo.Board.Layer.StonesLayer.Service","ngGo.Board.Layer.MarkupLayer.Service","ngGo.Board.Layer.ScoreLayer.Service","ngGo.Board.Layer.HoverLayer.Service","ngGo.Board.Object.Markup.Service","ngGo.Board.Object.Stone.Service","ngGo.Board.Object.StoneMini.Service","ngGo.Board.Object.StoneFaded.Service"]).provider("Board",function(){var a={width:0,height:0,cutoff:[],section:{top:0,right:0,bottom:0,left:0},coordinates:!1,color_multiplier:1};this.setConfig=function(c){a=b.extend(a,c)},this.$get=["$rootScope","BoardTheme","GridLayer","ShadowLayer","StonesLayer","MarkupLayer","ScoreLayer","HoverLayer",function(c,d,e,f,g,h,i,j){var k=function(a){this.init(),this.parseConfig(a||{})};return k.prototype.init=function(){this.removeAll(),this.theme=new d,this.cellSize=0,this.drawWidth=0,this.drawHeight=0,this.drawMarginHor=0,this.drawMarginVer=0,this.gridDrawWidth=0,this.gridDrawHeight=0,this.layerOrder=["grid","shadow","stones","score","markup","hover"],this.layers={grid:new e(this),shadow:new f(this),stones:new g(this),markup:new h(this),score:new i(this),hover:new j(this)},this.static=!1,this.margin=this.theme.get("board.margin"),this.colorMultiplier=1,this.coordinates=!1,this.layers.grid.setCoordinates(!1),this.width=0,this.height=0,this.cutoff={top:!1,left:!1,right:!1,bottom:!1},this.section={top:0,left:0,right:0,bottom:0}},k.prototype.linkElement=function(a){this.element=a},k.prototype.makeStatic=function(){this.static=!0,this.layerOrder=["grid","stones","markup"]},k.prototype.parseConfig=function(c){"object"==typeof c&&(c=b.extend({},a,c),this.toggleCoordinates(c.coordinates),this.swapColors(c.color_multiplier),this.setCutoff(c.cutoff),this.setSection(c.section),this.setSize(c.width,c.height))},k.prototype.setMargin=function(a){return"undefined"==typeof a&&(a=this.theme.get("board.margin")),this.margin!=a&&(this.margin=a,this.resized()),this},k.prototype.setCutoff=function(a){a&&b.isArray(a)||(a=[]);var c=!1;for(var d in this.cutoff)-1!=a.indexOf(d)?this.cutoff[d]||(this.cutoff[d]=!0,c=!0):this.cutoff[d]&&(this.cutoff[d]=!1,c=!0);return c&&this.resized(),this},k.prototype.setSection=function(a){return a&&"object"==typeof a?(a=b.extend({top:0,left:0,right:0,bottom:0},a),this.section.top==a.top&&this.section.bottom==a.bottom&&this.section.left==a.left&&this.section.right==a.right?this:(this.section=a,this.resized(),this)):this},k.prototype.setSize=function(a,b){if(a=parseInt(a||b||0),b=parseInt(b||a||0),!isNaN(a)&&!isNaN(b)){if(a!=this.width||b!=this.height){this.width=a,this.height=b;for(var d in this.layers)this.layers[d].setSize(a,b);c.$broadcast("ngGo.board.resize",this,a,b)}return this}},k.prototype.setDrawSize=function(a,b){(a!=this.drawWidth||b!=this.drawHeight)&&(this.drawWidth=a,this.drawHeight=b,this.resized())},k.prototype.toggleCoordinates=function(a){this.coordinates="undefined"!=typeof a?a:!this.coordinates,this.layers.grid.setCoordinates(this.coordinates),this.setMargin(this.coordinates?this.theme.get("coordinates.margin"):this.theme.get("board.margin"))},k.prototype.swapColors=function(a){if("undefined"==typeof a)a=-this.colorMultiplier;else if(a=parseInt(a),isNaN(a))return;a!=this.colorMultiplier&&(this.colorMultiplier=a,this.static?this.redraw():(this.redraw("stones"),this.redraw("markup")))},k.prototype.getTheme=function(){return this.theme},k.prototype.setTheme=function(a){return this.theme=a,this},k.prototype.add=function(a,b,c,d){"undefined"!=typeof this.layers[a]&&this.layers[a].add(b,c,d)},k.prototype.remove=function(a,b,c){"undefined"!=typeof this.layers[a]&&this.layers[a].remove(b,c)},k.prototype.get=function(a,b,c){return this.layers[a]&&this.layers[a].get(b,c)},k.prototype.has=function(a,b,c){return this.layers[a]&&this.layers[a].has(b,c)},k.prototype.setAll=function(a,b){"undefined"!=typeof this.layers[a]&&this.layers[a].setAll(b)},k.prototype.removeAll=function(a){if(a)"undefined"!=typeof this.layers[a]&&this.layers[a].removeAll();else for(a in this.layers)this.layers[a].removeAll()},k.prototype.updatePosition=function(a,b){this.width&&this.height||this.setSize(a.width,a.height),b&&this.removeAll("markup"),this.setAll("stones",a.stones),this.setAll("markup",a.markup)},k.prototype.getState=function(a){if(a)return this.layers[a]?this.layers[a].getAll():null;var b={};for(a in this.layers){var c=this.layers[a].getAll();c&&!c.isEmpty()&&(b[a]=c)}return b},k.prototype.restoreState=function(a,b){if(b)return void(this.layers[b]&&this.layers[b].setAll(a));for(b in this.layers)this.layers[b].removeAll(),a[b]&&this.layers[b].setAll(a[b])},k.prototype.clear=function(a){if(a){if(this.static||!this.layers[a])return;return void this.layers[a].clear()}if(this.static)return void this.layers.stones.clear();for(a in this.layers)this.layers[a].clear()},k.prototype.redraw=function(a){if(this.width&&this.height&&this.drawWidth&&this.drawHeight){if(a){if(this.static||!this.layers[a])return;return void this.layers[a].redraw()}this.clear();for(var b=0;b<this.layerOrder.length;b++)a=this.layerOrder[b],this.layers[a].draw()}},k.prototype.resized=function(){if(this.grid={xLeft:0+this.section.left,xRight:this.width-1-this.section.right,yTop:0+this.section.top,yBot:this.height-1-this.section.bottom},this.width&&this.height&&this.drawWidth&&this.drawHeight){var a=this.width+this.margin,b=this.height+this.margin;for(var c in this.cutoff)this.cutoff[c]&&("top"==c||"bottom"==c?b+=.5:a+=.5);this.cellSize=Math.floor(Math.min(this.drawWidth/a,this.drawHeight/b)),this.gridDrawWidth=this.cellSize*(a-this.margin-1),this.gridDrawHeight=this.cellSize*(b-this.margin-1),this.drawMarginHor=Math.floor((this.drawWidth-this.gridDrawWidth)/2),this.drawMarginVer=Math.floor((this.drawHeight-this.gridDrawHeight)/2),this.redraw()}},k.prototype.getCellSize=function(){return this.cellSize},k.prototype.getAbsX=function(a){var b=this.cutoff.left?.5:0;return this.drawMarginHor+Math.round((a+b)*this.cellSize)},k.prototype.getAbsY=function(a){var b=this.cutoff.top?.5:0;return this.drawMarginVer+Math.round((a+b)*this.cellSize)},k.prototype.getGridX=function(a){var b=this.cutoff.left?.5:0;return Math.round((a-this.drawMarginHor)/this.cellSize-b)},k.prototype.getGridY=function(a){var b=this.cutoff.top?.5:0;return Math.round((a-this.drawMarginVer)/this.cellSize-b)},k.prototype.isOnBoard=function(a,b){return a>=this.grid.xLeft&&b>=this.grid.yTop&&a<=this.grid.xRight&&b<=this.grid.yBot},k}]}),b.module("ngGo.Board.DefaultClearHandler.Service",["ngGo"]).factory("DefaultClearHandler",function(){return function(a,b){if(a){var c=this.board.getAbsX(b.x),d=this.board.getAbsY(b.y),e=this.board.getCellSize(),f=this.board.theme.get("stone.radius",e);a.clearRect(c-f,d-f,2*f,2*f)}}}),b.module("ngGo.Board.Grid.Service",["ngGo","ngGo.Board.GridChanges.Service"]).factory("BoardGrid",["BoardGridChanges",function(a){var c=function(a,c,d){var e={x:a,y:c};return"object"==typeof this.grid[a][c]?b.extend(e,this.grid[a][c]):(e[d]=this.grid[a][c],e)},d=function(a,b,c){this.width=0,this.height=0,this.grid=[],this.emptyValue=null,"undefined"!=typeof c&&(this.emptyValue=c),(a||b)&&this.setSize(a,b)};return d.prototype.set=function(a,b,c){this.isOnGrid(a,b)&&(this.grid[a][b]=c)},d.prototype.unset=function(a,b){this.isOnGrid(a,b)&&(this.grid[a][b]=this.emptyValue)},d.prototype.has=function(a,b){return this.isOnGrid(a,b)&&this.grid[a][b]!==this.emptyValue},d.prototype.is=function(a,b,c){return this.isOnGrid(a,b)&&this.grid[a][b]===c},d.prototype.get=function(a,b,d){return this.isOnGrid(a,b)&&this.grid[a][b]!==this.emptyValue?d?c.call(this,a,b,d):this.grid[a][b]:this.emptyValue},d.prototype.all=function(a){if(!a)return this.grid;for(var b=[],d=0;d<this.width;d++)for(var e=0;e<this.height;e++)this.grid[d][e]!==this.emptyValue&&b.push(c.call(this,d,e,a));return b},d.prototype.isEmpty=function(){for(var a=0;a<this.width;a++)for(var b=0;b<this.height;b++)if(this.grid[a][b]!==this.emptyValue)return!1;return!0},d.prototype.populate=function(a){for(var b=0;b<this.width;b++)for(var c=0;c<this.height;c++)this.grid[b][c]=a},d.prototype.empty=function(){for(var a=0;a<this.width;a++)for(var b=0;b<this.height;b++)this.grid[a][b]=this.emptyValue},d.prototype.clone=function(){var a=new d;return a.grid=b.copy(this.grid),a.emptyValue=this.emptyValue,a.width=this.width,a.height=this.height,a},d.prototype.isSameAs=function(a){if(this.width!=a.width||this.height!=a.height)return!1;for(var b=0;b<this.width;b++)for(var c=0;c<this.height;c++)if(this.grid[b][c]!=a[b][c])return!1;return!0},d.prototype.compare=function(b,d){var e=new a;if(this.width!=b.width||this.height!=b.height)return console.warn("Trying to compare grids of a different size"),e;for(var f=0;f<this.width;f++)for(var g=0;g<this.height;g++)b.grid[f][g]!==this.emptyValue&&b.grid[f][g]!==this.grid[f][g]&&e.add.push(c.call(b,f,g,d)),this.grid[f][g]!==this.emptyValue&&b.grid[f][g]!==this.grid[f][g]&&e.remove.push(c.call(this,f,g,d));return e},d.prototype.isOnGrid=function(a,b){return a>=0&&b>=0&&a<this.width&&b<this.height},d.prototype.whenEmpty=function(a){this.emptyValue=a},d.prototype.setSize=function(a,b){a=a||b||0,b=b||a||0,this.width=parseInt(a),this.height=parseInt(b),this.grid=[];for(var c=0;c<this.width;c++){this.grid[c]=[];for(var d=0;d<this.height;d++)this.grid[c][d]=this.emptyValue}},d.prototype.getSize=function(){return{width:this.width,height:this.height}},d}]),b.module("ngGo.Board.GridChanges.Service",["ngGo"]).factory("BoardGridChanges",function(){var a=function(a,b){var c,d=[];for(var e in a){c=!0;for(var f in b)if(a[e].x==b[f].x&&a[e].y==b[f].y){c=!1;break}c&&d.push(a[e])}return d};return function(){this.add=[],this.remove=[],this.concat=function(b){this.add=a(this.add,b.remove).concat(b.add),this.remove=a(this.remove,b.add).concat(b.remove)},this.has=function(){return!(!this.add.length&&!this.remove.length)}}}),b.module("ngGo.Board.Layer.Service",["ngGo","ngGo.Board.Grid.Service"]).factory("BoardLayer",["BoardGrid",function(a){var b=function(b,c){this.board=b,this.context=c,this.grid=new a};return b.prototype.setSize=function(a,b){this.grid.setSize(a,b)},b.prototype.getAll=function(){return this.grid.clone()},b.prototype.setAll=function(a){this.grid=a.clone()},b.prototype.removeAll=function(){this.clear(),this.grid.empty()},b.prototype.add=function(a,b,c){this.clearCell(a,b),this.grid.set(a,b,c),this.drawCell(a,b)},b.prototype.remove=function(a,b){this.clearCell(a,b),this.grid.unset(a,b)},b.prototype.get=function(a,b){return this.grid.get(a,b)},b.prototype.has=function(a,b){return this.grid.has(a,b)},b.prototype.draw=function(){},b.prototype.clear=function(){this.context&&this.context.clearRect(0,0,this.context.canvas.clientWidth,this.context.canvas.clientHeight)},b.prototype.redraw=function(){this.clear(),this.draw()},b.prototype.drawCell=function(){},b.prototype.clearCell=function(){},b.prototype.redrawCell=function(a,b){this.clearCell(a,b),this.drawCell(a,b)},b.prototype.setContext=function(a){this.context=a},b.prototype.getContext=function(){return this.context},b}]),b.module("ngGo.Board.Layer.GridLayer.Service",["ngGo","ngGo.Board.Layer.Service","ngGo.Board.Object.Coordinates.Service"]).factory("GridLayer",["BoardLayer","Coordinates",function(a,c){var d=function(a,b,c,d){if(!(a<this.board.grid.xLeft||a>this.board.grid.xRight||b<this.board.grid.yTop||b>this.board.grid.yBot)){var e=this.board.getAbsX(a),f=this.board.getAbsY(b);this.context.beginPath(),this.context.fillStyle=d,this.context.arc(e,f,c,0,2*Math.PI,!0),this.context.fill()}},e=function(b,c){this.coordinates=!1,a.call(this,b,c)};return b.extend(e.prototype,a.prototype),e.prototype.setCoordinates=function(a){this.coordinates=a},e.prototype.getAll=function(){return null},e.prototype.setAll=function(){},e.prototype.removeAll=function(){},e.prototype.draw=function(){if(this.context&&0!==this.board.drawWidth&&0!==this.board.drawheight){var a=this.board.drawMarginHor,b=this.board.drawMarginVer,e=this.board.getCellSize(),f=this.board.theme.get("grid.lineWidth",e),g=this.board.theme.get("grid.lineCap"),h=this.board.theme.get("grid.lineColor"),i=this.board.theme.get("grid.star.radius",e),j=this.board.theme.get("grid.star.color"),k=this.board.theme.get("grid.star.points",this.board.width,this.board.height),l=this.board.theme.canvasTranslate(f);this.context.translate(l,l),this.context.beginPath(),this.context.lineWidth=f,this.context.lineCap=g,this.context.strokeStyle=h;var m,n,o;for(m=this.board.grid.xLeft;m<=this.board.grid.xRight;m++)n=this.board.getAbsX(m),this.context.moveTo(n,b),this.context.lineTo(n,b+this.board.gridDrawHeight);for(m=this.board.grid.yTop;m<=this.board.grid.yBot;m++)o=this.board.getAbsY(m),this.context.moveTo(a,o),this.context.lineTo(a+this.board.gridDrawWidth,o);this.context.stroke();for(m in k)d.call(this,k[m].x,k[m].y,i,j);this.context.translate(-l,-l),this.coordinates&&c.draw.call(this)}},e.prototype.clearCell=function(a,b){var c=this.board.getAbsX(a),d=this.board.getAbsY(b),e=this.board.getCellSize(),f=this.board.theme.get("stone.radius",e),g=this.board.theme.get("grid.lineWidth",e),h=this.board.theme.canvasTranslate(g);this.context.translate(h,h),this.context.clearRect(c-f,d-f,2*f,2*f),this.context.translate(-h,-h)},e.prototype.redrawCell=function(a,b){var c=this.board.getAbsX(a),e=this.board.getAbsY(b),f=this.board.getCellSize(),g=this.board.theme.get("stone.radius",f),h=this.board.theme.get("grid.lineWidth",f),i=this.board.theme.get("grid.lineColor"),j=this.board.theme.get("grid.star.radius",f),k=this.board.theme.get("grid.star.color"),l=this.board.theme.canvasTranslate(h),m=this.board.theme.get("grid.star.points",this.board.width,this.board.height),n=0===a?c:c-g,o=a===this.board.width-1?c:c+g,p=0===b?e:e-g,q=b===this.board.height-1?e:e+g;this.context.translate(l,l),this.context.beginPath(),this.context.lineWidth=h,this.context.strokeStyle=i,this.context.moveTo(n,e),this.context.lineTo(o,e),this.context.moveTo(c,p),this.context.lineTo(c,q),this.context.stroke();for(var r in m)m[r].x==a&&m[r].y==b&&d.call(this,a,b,j,k);this.context.translate(-l,-l)},e}]),b.module("ngGo.Board.Layer.HoverLayer.Service",["ngGo","ngGo.Board.Layer.Service","ngGo.Board.Object.Markup.Service","ngGo.Board.Object.StoneFaded.Service"]).factory("HoverLayer",["BoardLayer","Markup","StoneFaded",function(a,c,d){var e=function(b,c){this.restore=[],a.call(this,b,c)};return b.extend(e.prototype,a.prototype),e.prototype.add=function(a,e,f){if(this.grid.isOnGrid(a,e)){if(this.remove(a,e),f.object={x:a,y:e},"stones"==f.type)f.objectClass=d,f.object.color=f.value;else{if("markup"!=f.type)return void console.warn("Unknown hover type",f.type);f.objectClass=c,"object"==typeof f.value?f.object=b.extend(f.object,f.value):f.object.type=f.value}this.board.has(f.type,a,e)&&(this.restore.push({x:a,y:e,layer:f.type,value:this.board.get(f.type,a,e)}),this.board.remove(f.type,a,e)),this.grid.set(a,e,f),f.objectClass&&f.objectClass.draw&&f.objectClass.draw.call(this,f.object)}},e.prototype.remove=function(a,b){if(this.grid.has(a,b)){var c=this.grid.get(a,b);c.objectClass&&c.objectClass.clear&&c.objectClass.clear.call(this,c.object);for(var d=0;d<this.restore.length;d++)this.restore[d].x==a&&this.restore[d].y==b&&(this.board.add(this.restore[d].layer,this.restore[d].x,this.restore[d].y,this.restore[d].value),this.restore.splice(d,1))}},e.prototype.removeAll=function(){if(!this.grid.isEmpty()){var a,b=this.grid.all("layer");for(a=0;a<b.length;a++)b[a].objectClass&&b[a].objectClass.clear&&b[a].objectClass.clear.call(this,b[a].object);for(this.clear(),this.grid.empty(),a=0;a<this.restore.length;a++)this.board.add(this.restore[a].layer,this.restore[a].x,this.restore[a].y,this.restore[a].value);this.restore=[]}},e.prototype.draw=function(){if(this.context&&0!==this.board.drawWidth&&0!==this.board.drawheight)for(var a=this.grid.all("hover"),b=0;b<a.length;b++)a.objectClass&&a.objectClass.draw&&a.objectClass.draw.call(this,a.object)},e}]),b.module("ngGo.Board.Layer.MarkupLayer.Service",["ngGo","ngGo.Board.Layer.Service","ngGo.Board.Object.Markup.Service"]).factory("MarkupLayer",["BoardLayer","Markup",function(a,c){var d=function(b,c){a.call(this,b,c)};return b.extend(d.prototype,a.prototype),d.prototype.setAll=function(a){var b,d=this.grid.compare(a,"type");for(b=0;b<d.remove.length;b++)c.clear.call(this,d.remove[b]);for(b=0;b<d.add.length;b++)c.draw.call(this,d.add[b]);this.grid=a.clone()},d.prototype.removeAll=function(){for(var a=this.grid.all("type"),b=0;b<a.length;b++)c.clear.call(this,a[b]);this.grid.empty()},d.prototype.draw=function(){if(this.context&&0!==this.board.drawWidth&&0!==this.board.drawheight)for(var a=this.grid.all("type"),b=0;b<a.length;b++)c.draw.call(this,a[b])},d.prototype.drawCell=function(a,b){0!==this.board.drawWidth&&0!==this.board.drawheight&&this.grid.has(a,b)&&c.draw.call(this,this.grid.get(a,b,"type"))},d.prototype.clearCell=function(a,b){this.grid.has(a,b)&&c.clear.call(this,this.grid.get(a,b,"type"))},d}]),b.module("ngGo.Board.Layer.ScoreLayer.Service",["ngGo","ngGo.Board.Layer.Service","ngGo.Board.Object.StoneMini.Service","ngGo.Board.Object.StoneFaded.Service"]).factory("ScoreLayer",["BoardLayer","StoneMini","StoneFaded",function(a,c,d){var e=function(b,c){this.points=[],this.captures=[],a.call(this,b,c)};return b.extend(e.prototype,a.prototype),e.prototype.setAll=function(a,b){this.removeAll(),this.points=a.all("color"),this.captures=b.all("color"),this.draw()},e.prototype.removeAll=function(){for(var a=0;a<this.captures.length;a++)this.board.add("stones",this.captures[a].x,this.captures[a].y,this.captures[a].color);this.clear(),this.points=[],this.captures=[]},e.prototype.draw=function(){if(this.context&&0!==this.board.drawWidth&&0!==this.board.drawheight){var a;for(a=0;a<this.captures.length;a++)this.board.remove("stones",this.captures[a].x,this.captures[a].y),d.draw.call(this,this.captures[a]);for(a=0;a<this.points.length;a++)c.draw.call(this,this.points[a])}},e}]),b.module("ngGo.Board.Layer.ShadowLayer.Service",["ngGo","ngGo.Board.Layer.Service","ngGo.Board.Object.StoneShadow.Service"]).factory("ShadowLayer",["BoardLayer","StoneShadow",function(a,c){var d=function(b,c){a.call(this,b,c)};return b.extend(d.prototype,a.prototype),d.prototype.add=function(a){a.shadow===!1||"undefined"!=typeof a.alpha&&a.alpha<1||this.grid.has(a.x,a.y)||(this.grid.set(a.x,a.y,a.color),this.context&&0!==this.board.drawWidth&&0!==this.board.drawheight&&c.draw.call(this,a))},d.prototype.remove=function(a){this.grid.unset(a.x,a.y),this.redraw()},d.prototype.draw=function(){if(this.context&&0!==this.board.drawWidth&&0!==this.board.drawheight){var a=this.board.theme.get("shadow.size",this.board.getCellSize());this.context.setTransform(1,0,0,1,a,a);for(var b=this.grid.all("color"),d=0;d<b.length;d++)c.draw.call(this,b[d])}},d}]),b.module("ngGo.Board.Layer.StonesLayer.Service",["ngGo","ngGo.Board.Layer.Service","ngGo.Board.Object.Stone.Service"]).factory("StonesLayer",["BoardLayer","Stone","StoneColor",function(a,c,d){var e=function(b,c){a.call(this,b,c),this.grid.whenEmpty(d.EMPTY)};return b.extend(e.prototype,a.prototype),e.prototype.setAll=function(a){var b,d=this.grid.compare(a,"color");for(b=0;b<d.remove.length;b++)c.clear.call(this,d.remove[b]);for(b=0;b<d.add.length;b++)c.draw.call(this,d.add[b]);this.grid=a.clone()},e.prototype.draw=function(){if(this.context&&0!==this.board.drawWidth&&0!==this.board.drawheight)for(var a=this.grid.all("color"),b=0;b<a.length;b++)c.draw.call(this,a[b])},e.prototype.redraw=function(){this.board.removeAll("shadow"),this.clear(),this.draw()},e.prototype.drawCell=function(a,b){0!==this.board.drawWidth&&0!==this.board.drawheight&&this.grid.has(a,b)&&c.draw.call(this,this.grid.get(a,b,"color"))},e.prototype.clearCell=function(a,b){this.grid.has(a,b)&&c.clear.call(this,this.grid.get(a,b,"color"))},e}]),b.module("ngGo.Board.Object.Service",["ngGo","ngGo.Board.DefaultClearHandler.Service"]).factory("BoardObject",["DefaultClearHandler",function(a){var b={draw:function(){0===this.board.drawWidth||0===this.board.drawheight},clear:function(b){a.call(this,this.context,b)}};return b}]),b.module("ngGo.Board.Object.Coordinates.Service",["ngGo"]).factory("Coordinates",function(){var a=["一","二","三","四","五","六","七","八","九","十","十一","十二","十三","十四","十五","十六","十七","十八","十九","二十","二十一","二十二","二十三","二十四","二十五","二十六","二十七","二十八","二十九","三十","三十一","三十二","三十三","三十四","三十五","三十六","三十七","三十八","三十九","四十"],b="A".charCodeAt(0),c=("I".charCodeAt(0),"a".charCodeAt(0)),d={kanji:function(b){return a[b]||""},numbers:function(a){return a+1},letters:function(a){var c="";return a>=25&&(c="A",a-=25),a>=8&&a++,c+String.fromCharCode(b+a)},jgf:function(a){return a},sgf:function(a){var d;return d=26>a?c+a:b+a,String.fromCharCode(d)}},e={draw:function(){if(this.context&&0!==this.board.drawWidth&&0!==this.board.drawheight){var a=this.board.getCellSize(),b=Math.ceil((this.board.drawMarginHor-a/2)/2),c=this.board.drawWidth-b,e=Math.ceil((this.board.drawMarginVer-a/2)/2),f=this.board.drawHeight-e,g=(this.board.theme.get("stone.radius",a),this.board.theme.get("coordinates.color")),h={font:this.board.theme.get("coordinates.vertical.font"),size:this.board.theme.get("coordinates.vertical.size"),style:this.board.theme.get("coordinates.vertical.style"),inverse:this.board.theme.get("coordinates.vertical.inverse")},i={font:this.board.theme.get("coordinates.horizontal.font"),size:this.board.theme.get("coordinates.horizontal.size"),style:this.board.theme.get("coordinates.horizontal.style"),inverse:this.board.theme.get("coordinates.horizontal.inverse")};this.context.fillStyle=g,this.context.textBaseline="middle",this.context.textAlign="center";var j,k,l,m,n;for(j=0;j<this.board.height;j++)k=j,h.inverse&&(k=this.board.height-j-1),n="function"==typeof h.style?h.style.call(this,k):d[h.style]?d[h.style].call(this,k):k,m=this.board.getAbsY(j),this.context.font=h.size(n,a)+" "+h.font,this.context.fillText(n,b,m),this.context.fillText(n,c,m);for(j=0;j<this.board.width;j++)k=j,i.inverse&&(k=this.board.width-j-1),n="function"==typeof i.style?i.style.call(this,k):d[i.style]?d[i.style].call(this,k):k,l=this.board.getAbsX(j),this.context.font=i.size(n,a)+" "+i.font,this.context.fillText(n,l,e),this.context.fillText(n,l,f)}}};return e}),b.module("ngGo.Board.Object.Markup.Service",["ngGo","ngGo.Board.Object.Service"]).factory("Markup",["MarkupTypes","BoardObject",function(a,b){var c=Math.cos(Math.PI/4),d=Math.cos(Math.PI/6),e=function(a){var b=this.board.getAbsX(a.x),c=this.board.getAbsY(a.y),e=this.board.getCellSize(),f=Math.round(this.board.theme.get("stone.radius",e)*this.board.theme.get("markup.triangle.scale"));a.scale&&(f=Math.round(f*a.scale));var g=this.board.get("stones",a.x,a.y)*this.board.colorMultiplier,h=a.lineWidth||this.board.theme.get("markup.lineWidth",e)||1,i=a.color||this.board.theme.get("markup.color",g),j=this.board.theme.canvasTranslate(h);this.context.translate(j,j),this.context.strokeStyle=i,this.context.lineWidth=h,this.context.beginPath(),this.context.moveTo(b,c-f),this.context.lineTo(b-Math.round(f*d),c+Math.round(f/2)),this.context.lineTo(b+Math.round(f*d),c+Math.round(f/2)),this.context.closePath(),this.context.stroke(),this.context.translate(-j,-j)},f=function(a){var b=this.board.getAbsX(a.x),d=this.board.getAbsY(a.y),e=this.board.getCellSize(),f=Math.round(this.board.theme.get("stone.radius",e)*this.board.theme.get("markup.square.scale"));a.scale&&(f=Math.round(f*a.scale));var g=Math.round(f*c),h=this.board.get("stones",a.x,a.y)*this.board.colorMultiplier,i=a.lineWidth||this.board.theme.get("markup.lineWidth",e)||1,j=a.color||this.board.theme.get("markup.color",h),k=this.board.theme.canvasTranslate(i);this.context.translate(k,k),this.context.strokeStyle=j,this.context.lineWidth=i,this.context.beginPath(),this.context.rect(b-g,d-g,2*g,2*g),this.context.stroke(),this.context.translate(-k,-k)},g=function(a){var b=this.board.getAbsX(a.x),c=this.board.getAbsY(a.y),d=this.board.getCellSize(),e=Math.round(this.board.theme.get("stone.radius",d)*this.board.theme.get("markup.circle.scale"));a.scale&&(e=Math.round(e*a.scale));var f=this.board.get("stones",a.x,a.y)*this.board.colorMultiplier,g=a.lineWidth||this.board.theme.get("markup.lineWidth",d)||1,h=a.color||this.board.theme.get("markup.color",f),i=this.board.theme.canvasTranslate();this.context.translate(i,i),this.context.strokeStyle=h,this.context.lineWidth=g,this.context.beginPath(),this.context.arc(b,c,e,0,2*Math.PI,!0),this.context.stroke(),this.context.translate(-i,-i)},h=function(a){var b=this.board.getAbsX(a.x),d=this.board.getAbsY(a.y),e=this.board.getCellSize(),f=Math.round(this.board.theme.get("stone.radius",e)*this.board.theme.get("markup.mark.scale"));a.scale&&(f=Math.round(f*a.scale));var g=Math.round(f*c),h=this.board.get("stones",a.x,a.y)*this.board.colorMultiplier,i=a.lineWidth||this.board.theme.get("markup.lineWidth",e)||1,j=a.lineCap||this.board.theme.get("markup.mark.lineCap"),k=a.color||this.board.theme.get("markup.color",h),l=this.board.theme.canvasTranslate(i);this.context.translate(l,l),this.context.strokeStyle=k,this.context.lineWidth=i,this.context.lineCap=j,this.context.beginPath(),this.context.moveTo(b-g,d-g),this.context.lineTo(b+g,d+g),this.context.moveTo(b+g,d-g),this.context.lineTo(b-g,d+g),this.context.stroke(),this.context.translate(-l,-l)},i=function(a){var b=this.board.getAbsX(a.x),c=this.board.getAbsY(a.y),d=this.board.getCellSize(),e=Math.round(this.board.theme.get("stone.radius",d)*this.board.theme.get("markup.circle.scale"));a.scale&&(e=Math.round(e*a.scale));var f=this.board.get("stones",a.x,a.y)*this.board.colorMultiplier,g=a.lineWidth||this.board.theme.get("markup.lineWidth",d)||1,h=a.color||this.board.theme.get("markup.color",f),i=this.board.theme.canvasTranslate();this.context.translate(i,i),this.context.fillStyle=h,this.context.lineWidth=g,this.context.beginPath(),this.context.arc(b,c,e,0,2*Math.PI,!0),this.context.fill(),this.context.translate(-i,-i)},j=function(a){var b=this.board.getAbsX(a.x),c=this.board.getAbsY(a.y),d=this.board.getCellSize(),e=Math.round(this.board.theme.get("stone.radius",d)*this.board.theme.get("markup.last.scale"));a.scale&&(e=Math.round(e*a.scale));var f=this.board.get("stones",a.x,a.y)*this.board.colorMultiplier,g=a.color||this.board.theme.get("markup.color",f),h=this.board.theme.canvasTranslate(d);this.context.translate(h,h),this.context.fillStyle=g,this.context.beginPath(),this.context.moveTo(b,c),this.context.lineTo(b+e,c),this.context.lineTo(b,c+e),this.context.closePath(),this.context.fill(),this.context.translate(-h,-h)},k=function(a){var b=this.board.getAbsX(a.x),c=this.board.getAbsY(a.y),d=this.board.getCellSize(),e=Math.round(this.board.theme.get("stone.radius",d)*this.board.theme.get("markup.smiley.scale"));a.scale&&(e=Math.round(e*a.scale));var f=this.board.get("stones",a.x,a.y)*this.board.colorMultiplier,g=a.lineWidth||this.board.theme.get("markup.lineWidth",d)||1,h=a.lineCap||this.board.theme.get("markup.smiley.lineCap"),i=a.color||this.board.theme.get("markup.color",f),j=this.board.theme.canvasTranslate();this.context.translate(j,j),this.context.strokeStyle=i,this.context.lineWidth=g,this.context.lineCap=h,this.context.beginPath(),this.context.arc(b-e/3,c-e/3,e/6,0,2*Math.PI,!0),this.context.stroke(),this.context.beginPath(),this.context.arc(b+e/3,c-e/3,e/6,0,2*Math.PI,!0),this.context.stroke(),this.context.beginPath(),this.context.moveTo(b-e/1.6,c+e/8),this.context.bezierCurveTo(b-e/1.8,c+e/1.5,b+e/1.8,c+e/1.5,b+e/1.6,c+e/8),this.context.stroke(),this.context.translate(-j,-j)},l=function(a){var b=this.board.getAbsX(a.x),c=this.board.getAbsY(a.y),d=this.board.getCellSize(),e=Math.round(this.board.theme.get("stone.radius",d)*this.board.theme.get("markup.smiley.scale"));a.scale&&(e=Math.round(e*a.scale));var f=this.board.get("stones",a.x,a.y)*this.board.colorMultiplier,g=a.lineWidth||this.board.theme.get("markup.lineWidth",d)||1,h=a.lineCap||this.board.theme.get("markup.smiley.lineCap"),i=a.color||this.board.theme.get("markup.color",f),j=this.board.theme.canvasTranslate();this.context.translate(j,j),this.context.strokeStyle=i,this.context.lineWidth=g,this.context.lineCap=h,this.context.beginPath(),this.context.arc(b-e/3,c-e/3,e/6,0,2*Math.PI,!0),this.context.stroke(),this.context.beginPath(),this.context.arc(b+e/3,c-e/3,e/6,0,2*Math.PI,!0),this.context.stroke(),this.context.beginPath(),this.context.moveTo(b-e/1.6,c+e/1.5-1),this.context.bezierCurveTo(b-e/1.8,c+e/8-1,b+e/1.8,c+e/8-1,b+e/1.6,c+e/1.5-1),this.context.stroke(),this.context.translate(-j,-j)},m=function(a){var b=this.board.getAbsX(a.x),c=this.board.getAbsY(a.y),d=this.board.getCellSize(),e=this.board.theme.get("stone.radius",d);a.scale&&(e=Math.round(e*a.scale));var f=this.board.get("stones",a.x,a.y)*this.board.colorMultiplier,g=a.font||this.board.theme.get("markup.label.font")||"",h=a.color||this.board.theme.get("markup.color",f),i=this.board.theme.canvasTranslate();this.board.has("stones",a.x,a.y)||this.board.layers.grid.clearCell(a.x,a.y),this.context.translate(i,i),this.context.fillStyle=h,this.context.textBaseline="middle",this.context.textAlign="center","number"==typeof a.text&&(a.text=a.text.toString()),this.context.font=1==a.text.length?Math.round(1.5*e)+"px "+g:2==a.text.length?Math.round(1.2*e)+"px "+g:e+"px "+g,this.context.beginPath(),this.context.fillText(a.text,b,c,2*e),this.context.translate(-i,-i)
},n=function(a){if(!this.board.has("stones",a.x,a.y)){{this.board.theme.get("stone.radius",this.board.getCellSize())}this.board.layers.grid.redrawCell(a.x,a.y)}},o={draw:function(b){if(this.context&&0!==this.board.drawWidth&&0!==this.board.drawheight)switch(b.type){case a.TRIANGLE:e.call(this,b);break;case a.SQUARE:f.call(this,b);break;case a.CIRCLE:g.call(this,b);break;case a.MARK:h.call(this,b);break;case a.SELECT:i.call(this,b);break;case a.HAPPY:k.call(this,b);break;case a.SAD:l.call(this,b);break;case a.LAST:j.call(this,b);break;case a.LABEL:b.text=b.text||"",m.call(this,b)}},clear:function(c){this.context&&0!==this.board.drawWidth&&0!==this.board.drawheight&&(b.clear.call(this,c),c.type==a.LABEL&&n.call(this,c))}};return o}]),b.module("ngGo.Board.Object.Stone.Service",["ngGo","ngGo.Board.Object.Service","ngGo.Board.ShellPattern.Service"]).factory("Stone",["$injector","BoardObject","StoneColor","ShellPattern",function(a,b,c,d){var e,f=function(a){var b=this.board.getAbsX(a.x),c=this.board.getAbsY(a.y),d=this.board.getCellSize(),e=this.board.theme.get("stone.radius",d);a.scale&&(e=Math.round(e*a.scale)),a.shadow=!1;var f=a.color*this.board.colorMultiplier,g=this.board.theme.get("stone.mono.lineWidth",d)||1,h=this.board.theme.get("stone.mono.color",f),i=this.board.theme.get("stone.mono.lineColor",f),j=this.board.theme.canvasTranslate();this.context.translate(j,j),a.alpha&&a.alpha<1&&(this.context.globalAlpha=a.alpha),this.context.fillStyle=h,this.context.beginPath(),this.context.arc(b,c,Math.max(0,e-g),0,2*Math.PI,!0),this.context.fill(),this.context.lineWidth=g,this.context.strokeStyle=i,this.context.stroke(),a.alpha&&a.alpha<1&&(this.context.globalAlpha=1),this.context.translate(-j,-j)},g=function(a){var b=this.board.getAbsX(a.x),d=this.board.getAbsY(a.y),e=this.board.getCellSize(),f=this.board.theme.get("stone.radius",e);a.scale&&(f=Math.round(f*a.scale));var g=a.color*this.board.colorMultiplier,h=this.board.theme.canvasTranslate();this.context.translate(h,h),a.alpha&&a.alpha<1&&(this.context.globalAlpha=a.alpha),this.context.beginPath(),g==c.W?(this.context.fillStyle=this.context.createRadialGradient(b-2*f/5,d-2*f/5,f/3,b-f/5,d-f/5,5*f/5),this.context.fillStyle.addColorStop(0,"#fff"),this.context.fillStyle.addColorStop(1,"#aaa")):(this.context.fillStyle=this.context.createRadialGradient(b-2*f/5,d-2*f/5,1,b-f/5,d-f/5,4*f/5),this.context.fillStyle.addColorStop(0,"#666"),this.context.fillStyle.addColorStop(1,"#111")),this.context.arc(b,d,Math.max(0,f-.5),0,2*Math.PI,!0),this.context.fill(),a.alpha&&a.alpha<1&&(this.context.globalAlpha=1),this.context.translate(-h,-h)},h=function(a){var b=this.board.getAbsX(a.x),f=this.board.getAbsY(a.y),g=this.board.getCellSize(),h=this.board.theme.get("stone.radius",g);a.scale&&(h=Math.round(h*a.scale)),e=e||Math.ceil(9999999*Math.random());var i=a.color*this.board.colorMultiplier,j=this.board.theme.get("stone.shell.types"),k=this.board.theme.get("stone.shell.color",i),l=this.board.theme.get("stone.shell.stroke"),m=this.board.theme.canvasTranslate();if(this.context.translate(m,m),a.alpha&&a.alpha<1&&(this.context.globalAlpha=a.alpha),this.context.beginPath(),this.context.arc(b,f,Math.max(0,h-.5),0,2*Math.PI,!0),this.context.fillStyle=k,this.context.fill(),i==c.W){var n=e%(j.length+a.x*this.board.width+a.y)%j.length,o=this.board.width*this.board.height+a.x*this.board.width+a.y,p=2/o*(e%o);d.call(j[n],this.context,b,f,h,p,l),this.context.beginPath(),this.context.fillStyle=this.context.createRadialGradient(b-2*h/5,f-2*h/5,h/6,b-h/5,f-h/5,h),this.context.fillStyle.addColorStop(0,"rgba(255,255,255,0.9)"),this.context.fillStyle.addColorStop(1,"rgba(255,255,255,0)"),this.context.arc(b,f,Math.max(0,h-.5),0,2*Math.PI,!0),this.context.fill()}else this.context.beginPath(),this.context.fillStyle=this.context.createRadialGradient(b+2*h/5,f+2*h/5,0,b+h/2,f+h/2,h),this.context.fillStyle.addColorStop(0,"rgba(32,32,32,1)"),this.context.fillStyle.addColorStop(1,"rgba(0,0,0,0)"),this.context.arc(b,f,Math.max(0,h-.5),0,2*Math.PI,!0),this.context.fill(),this.context.beginPath(),this.context.fillStyle=this.context.createRadialGradient(b-2*h/5,f-2*h/5,1,b-h/2,f-h/2,3*h/2),this.context.fillStyle.addColorStop(0,"rgba(64,64,64,1)"),this.context.fillStyle.addColorStop(1,"rgba(0,0,0,0)"),this.context.arc(b,f,Math.max(0,h-.5),0,2*Math.PI,!0),this.context.fill();a.alpha&&a.alpha<1&&(this.context.globalAlpha=1),this.context.translate(-m,-m)},i={draw:function(b){if(this.context&&0!==this.board.drawWidth&&0!==this.board.drawheight){var c=this.board.theme.get("stone.style");switch(c){case"shell":h.call(this,b);break;case"glass":g.call(this,b);break;case"mono":f.call(this,b);break;default:var d=a.get(c);d&&d.call(this,b)}!this.board.static&&b.shadow!==!1&&this.board.theme.get("stone.shadow")&&this.board.layers.shadow.add(b)}},clear:function(a){this.context&&0!==this.board.drawWidth&&0!==this.board.drawheight&&(b.clear.call(this,a),!this.board.static&&a.shadow!==!1&&this.board.theme.get("stone.shadow")&&this.board.layers.shadow.remove(a))}};return i}]),b.module("ngGo.Board.Object.StoneFaded.Service",["ngGo","ngGo.Board.Object.Stone.Service"]).factory("StoneFaded",["Stone",function(a){var b={draw:function(b){b.scale=this.board.theme.get("stone.faded.scale"),b.alpha=this.board.theme.get("stone.faded.alpha",b.color),b.shadow=!1,a.draw.call(this,b)},clear:function(b){b.shadow=!1,a.clear.call(this,b)}};return b}]),b.module("ngGo.Board.Object.StoneMini.Service",["ngGo","ngGo.Board.Object.Stone.Service"]).factory("StoneMini",["Stone",function(a){var b={draw:function(b){b.scale=this.board.theme.get("stone.mini.scale"),b.alpha=this.board.theme.get("stone.mini.alpha",b.color),b.shadow=!1,a.draw.call(this,b)},clear:function(b){b.shadow=!1,a.clear.call(this,b)}};return b}]),b.module("ngGo.Board.Object.StoneShadow.Service",["ngGo","ngGo.Board.Object.Service"]).factory("StoneShadow",["BoardObject",function(){var a={draw:function(a){if(this.context&&!(a.alpha&&a.alpha<1||a.shadow===!1)){var b=this.board.getAbsX(a.x),c=this.board.getAbsY(a.y),d=this.board.getCellSize(),e=Math.max(0,this.board.theme.get("stone.radius",d)-.5);a.scale&&(e=Math.round(e*a.scale));var f=this.board.theme.get("shadow.blur",d),g=this.board.theme.get("shadow.offsetX",d),h=this.board.theme.get("shadow.offsetY",d),i=this.board.theme.get("shadow.color");this.context.fillStyle=this.context.createRadialGradient(b+g,c+h,e-1-f,b+g,c+h,e+f),this.context.fillStyle.addColorStop(0,i),this.context.fillStyle.addColorStop(1,"rgba(0,0,0,0)"),this.context.beginPath(),this.context.arc(b+g,c+h,e+f,0,2*Math.PI,!0),this.context.fill()}},clear:function(a){if(this.context&&!(a.alpha&&a.alpha<1||a.shadow===!1)){var b=this.board.getAbsX(a.x),c=this.board.getAbsY(a.y),d=this.board.getCellSize(),e=this.board.theme.get("stone.radius",d);this.context.clearRect(b-1.2*e,c-1.2*e,2.4*e,2.4*e)}}};return a}]),b.module("ngGo.Board.ShellPattern.Service",["ngGo"]).factory("ShellPattern",function(){var a=function(a,b,c,d,e,f,g){a.shadowBlur=2,a.strokeStyle=g,a.lineWidth=d/30*this.thickness,a.beginPath(),d-=Math.max(1,a.lineWidth);var h,i,j=b+d*Math.cos(e*Math.PI),k=c+d*Math.sin(e*Math.PI),l=b+d*Math.cos(f*Math.PI),m=c+d*Math.sin(f*Math.PI);l>j?(h=(m-k)/(l-j),i=Math.atan(h)):l==j?i=Math.PI/2:(h=(m-k)/(l-j),i=Math.atan(h)-Math.PI);var n=this.factor*d,o=Math.sin(i)*n,p=Math.cos(i)*n,q=j+o,r=k-p,s=l+o,t=m-p;a.moveTo(j,k),a.bezierCurveTo(q,r,s,t,l,m),a.stroke()};return function(b,c,d,e,f,g){for(var h=f,i=f,j=0;j<this.lines.length;j++)h+=this.lines[j],i-=this.lines[j],a.call(this,b,c,d,e,h,i,g)}}),b.module("ngGo.Board.Theme.Service",["ngGo"]).provider("BoardTheme",["StoneColor","MarkupTypes",function(a,c){var d={board:{margin:.25},stone:{style:"shell",shadow:!0,radius:function(a){return Math.floor(a/2)},shell:{color:function(b){return b==a.B?"#111":"#BFBFBA"},stroke:"rgba(128,128,128,0.15)",types:[{lines:[.1,.12,.11,.1,.09,.09,.09,.09],factor:.15,thickness:1.75},{lines:[.1,.09,.08,.07,.09,.06,.06,.07,.07,.06,.06],factor:.1,thickness:1.5},{lines:[.22,.11,.13,.06,.11,.09],factor:.05,thickness:1.75},{lines:[.18,.23,.09,.17,.14],factor:.1,thickness:2}]},mono:{lineWidth:1,lineColor:function(){return"#000"},color:function(b){return b==a.B?"#000":"#fff"}},mini:{scale:.5,alpha:1},faded:{scale:1,alpha:function(b){return b==a.B?.3:.4}}},shadow:{color:"rgba(40,30,20,0.5)",size:function(a){return Math.floor(a/20)},blur:function(a){return a/20},offsetX:function(a){return Math.ceil(a/20)},offsetY:function(a){return Math.ceil(a/20)}},markup:{color:function(b){return b==a.B?"rgba(255,255,255,0.9)":"rgba(0,0,0,0.9)"},lineWidth:function(a){return Math.max(1,Math.floor(a/16))},triangle:{scale:.85},square:{scale:.85},circle:{scale:.55},mark:{lineCap:"square",scale:.75},last:{scale:.7},smiley:{lineCap:"round",scale:.85},label:{font:"Arial"},variation:{type:c.LABEL,text:function(a){return String.fromCharCode(65+a)},color:"rgba(86,114,30,0.9)"},solution:{valid:{type:c.SELECT,text:null,color:"rgba(86,114,30,1)",scale:.5},invalid:{type:c.MARK,text:null,color:"rgba(237,9,15,1)",scale:.3}}},grid:{lineColor:"rgba(60,40,15,1)",lineWidth:function(a){return a>60?2:a>50?1.5:1},lineCap:"square",star:{color:"rgba(60,40,15,1)",radius:function(a){return a>50?Math.floor(a/16+1):a>30?3:a>15?2:a>5?1.5:1},points:function(a,b){return a==b&&19==a?[{x:3,y:3},{x:9,y:3},{x:15,y:3},{x:3,y:9},{x:9,y:9},{x:15,y:9},{x:3,y:15},{x:9,y:15},{x:15,y:15}]:a==b&&13==a?[{x:3,y:3},{x:9,y:3},{x:3,y:9},{x:9,y:9}]:a==b&&9==a?[{x:4,y:4},{x:2,y:2},{x:2,y:6},{x:6,y:2},{x:6,y:6}]:[]}}},coordinates:{color:"rgba(101,69,37,0.5)",margin:1.25,vertical:{font:"Arial",style:"numbers",inverse:!0,size:function(){return function(a,b){return Math.floor(.3*b+1)+"px"}}},horizontal:{font:"Arial",style:"letters",inverse:!1,size:function(){return function(a,b){return Math.floor(.3*b+1)+"px"}}}}};this.setTheme=function(a){a&&(d=b.extendDeep(d,a))},this.$get=["StoneColor",function(){var a=function(a){this.instanceTheme=a,this.reset()};return a.prototype.reset=function(){this.theme=b.copy(d),this.instanceTheme&&b.extendDeep(this.theme,this.instanceTheme)},a.prototype.get=function(a){for(var b=a.split("."),c=this.theme,d=0;d<b.length;d++){if("undefined"==typeof c[b[d]])return console.warn("Could not find theme property",a),null;c=c[b[d]]}if("function"!=typeof c)return c;var e=[];if(arguments.length>1)for(var f=1;f<arguments.length;f++)e.push(arguments[f]);return c.apply(this,e)},a.prototype.set=function(a,b){for(var c=a.split("."),d=this.theme,e=0;e<c.length;e++){if(e+1==c.length){d[c[e]]=b;break}"undefined"==typeof d[c[e]]&&(d[c[e]]={}),d=d[c[e]]}return this},a.prototype.canvasTranslate=function(a){return"undefined"==typeof a&&(a=this.get("grid.lineWidth")),a%2*.5},a}]}]),b.module("ngGo.Errors.InvalidDataError.Service",["ngGo"]).factory("InvalidDataError",["ngGo",function(a){var b=function(b){switch(this.code=b,this.name="InvalidDataError",this.message="Invalid data: ",b){case a.error.NO_DATA:this.message+="no data to process.";break;case a.error.UNKNOWN_DATA:this.message+="unknown data format.";break;case a.error.INVALID_GIB:this.message+="unable to parse GIB data.";break;case a.error.INVALID_SGF:this.message+="unable to parse SGF data.";break;case a.error.INVALID_JGF_JSON:this.message+="unable to parse JGF data.";break;case a.error.INVALID_JGF_TREE_JSON:this.message+="unable to parse the JGF tree data.";break;default:this.message+="unable to parse the data."}};return b.prototype=new Error,b.prototype.constructor=b,b}]),b.module("ngGo.Errors.InvalidPositionError.Service",["ngGo"]).factory("InvalidPositionError",["ngGo","StoneColor",function(a,b){var c=function(c,d,e,f){switch(this.code=c,this.name="InvalidPositionError",this.message="Invalid position detected.","undefined"!=typeof d&&"undefined"!=typeof e&&"undefined"!=typeof f&&(this.message+=" Trying to place a "+(f==b.W?"white":"black")+" stone on ("+d+", "+e+")"),c){case a.error.POSTITION_OUT_OF_BOUNDS:this.message+=", but these coordinates are not on the board.";break;case a.error.POSTITION_ALREADY_HAS_STONE:this.message+=", but there is already a stone on those coordinates.";break;case a.error.POSTITION_IS_SUICIDE:this.message+=", but that would be suicide.";break;case a.error.POSTITION_IS_REPEATING:this.message+=", but this position already occured.";break;default:this.message+="."}};return c.prototype=new Error,c.prototype.constructor=c,c}]),b.module("ngGo.Game.Service",["ngGo","ngGo.Game.Path.Service","ngGo.Game.Node.Service","ngGo.Game.Position.Service","ngGo.Kifu.Blank.Service","ngGo.Kifu.Parser.Service","ngGo.Errors.InvalidDataError.Service","ngGo.Errors.InvalidPositionError.Service"]).provider("Game",function(){var a={defaultSize:0,defaultKomi:0,defaultHandicap:0,rememberPath:!0,checkRepeat:"KO",allowSuicide:!1};this.setConfig=function(c){a=b.extend(a,c)},this.$get=["ngGo","StoneColor","GamePath","GameNode","GamePosition","KifuParser","KifuBlank","InvalidDataError","InvalidPositionError",function(d,e,f,g,h,i,j,k,l){var m=function(){this.info.board||(this.info.board={}),this.info.game||(this.info.game={}),"undefined"==typeof this.info.board.width&&(this.info.board.width=this.config.defaultSize),"undefined"==typeof this.info.board.height&&(this.info.board.height=this.config.defaultSize),"undefined"==typeof this.info.game.komi&&(this.info.game.komi=this.config.defaultKomi),"undefined"==typeof this.info.game.handicap&&(this.info.game.handicap=this.config.defaultHandicap)},n=function(a){return 0===this.node.children.length?!1:(a===c&&(a=this.node._remembered_path),a=a||0,-1==a&&(a=0),a>=this.node.children.length||!this.node.children[a]?!1:(this.path.advance(a),this.node=this.node.children[a],!0))},o=function(){return this.node.parent?(this.path.retreat(),this.node=this.node.parent,!0):!1},p=function(){this.path.reset(),this.node=this.root,this.setTurn(this.info.game.handicap>1?e.W:e.B)},q=function(){1!=this.history.length&&(this.history=[],this.history.push(new h),this.info.board&&this.history[0].setSize(this.info.board.width,this.info.board.height))},r=function(a){return a||(a=this.position.clone()),this.history.push(a),a},s=function(){return 0===this.history.length?null:this.history.pop()},t=function(a){a&&(this.history.pop(),this.history.push(a))},u=function(){this.node.parent&&(this.node.parent._remembered_path=this.node.parent.children.indexOf(this.node));var a,b=this.position.clone();if(this.node.move&&(this.node.move.pass?b.setTurn(-this.node.move.color):this.validateMove(this.node.move.x,this.node.move.y,this.node.move.color,b)),this.node.turn&&b.setTurn(this.node.turn),this.node.setup)for(a in this.node.setup)b.stones.set(this.node.setup[a].x,this.node.setup[a].y,this.node.setup[a].color);if(this.node.markup)for(a in this.node.markup)b.markup.set(this.node.markup[a].x,this.node.markup[a].y,this.node.markup[a]);r.call(this,b)},v=function(c,d){this.config=b.extend({},a,d||{}),Object.defineProperty(this,"position",{get:function(){return this.history[this.history.length-1]},set:function(a){this.history[this.history.length]=a}}),c?this.load(c):this.init()};return v.prototype.init=function(){this.info={},this.root=null,this.node=null,this.path=new f,this.jgf=null,this.history=[]},v.prototype.load=function(a){this.init();try{this.fromData(a)}catch(b){throw q.call(this),new k(b)}this.first()},v.prototype.reload=function(){this.jgf&&this.load(this.jgf)},v.prototype.isLoaded=function(){return null!==this.root},v.prototype.clone=function(){for(var a=new v,c=Object.getOwnPropertyNames(this),d=0;d<c.length;d++)a[d]=b.copy(this[d]);return a},v.prototype.fromData=function(a){if(!a)throw d.error.NO_DATA;if("string"==typeof a){var b=a.charAt(0);if("("==b)return this.fromSgf(a);if("{"==b)return this.fromJgf(a);if("\\"==b)return this.fromGib(a);throw d.error.UNKNOWN_DATA}if("object"!=typeof a)throw d.error.UNKNOWN_DATA;this.fromJgf(a)},v.prototype.fromGib=function(a){var b=i.gib2jgf(a);if(!b)throw d.error.INVALID_GIB;this.fromJgf(b)},v.prototype.fromSgf=function(a){var b=i.sgf2jgf(a);if(!b)throw d.error.INVALID_SGF;this.fromJgf(b)},v.prototype.fromJgf=function(a){if("string"==typeof a)try{a=b.fromJson(a)}catch(c){throw d.error.INVALID_JGF_JSON}if("string"==typeof a.tree)if("["==a.tree.charAt(0))try{a.tree=b.fromJson(a.tree)}catch(c){throw d.error.INVALID_JGF_TREE_JSON}else a.tree=[];for(var e in a)"tree"!=e&&(this.info[e]=b.copy(a[e]));m.call(this),this.root=new g,a.tree&&this.root.fromJgf(a.tree),this.jgf=a},v.prototype.toSgf=function(){return i.jgf2sgf(this.toJgf())},v.prototype.toJgf=function(a){for(var c=j.jgf(),d=Object.getOwnPropertyNames(this),e=0;e<d.length;e++)"root"!=e&&(c[e]=c[e]?b.extend(c[e],this[e]):b.copy(this[e]));return c.tree=this.root.toJgf(),a?b.toJson(c):c},v.prototype.getNode=function(){return this.node},v.prototype.getPosition=function(){return this.position},v.prototype.getPath=function(a){return a?this.path.clone():this.path},v.prototype.clonePath=function(){return this.path.clone()},v.prototype.getPathToNode=function(a){return f.findNode(a,this.root)},v.prototype.getKomi=function(){return this.info.game.komi?parseFloat(this.info.game.komi):0},v.prototype.setKomi=function(a){this.info.game.komi=a?parseFloat(a):this.config.defaultKomi},v.prototype.getTurn=function(){return this.history.length?this.position.getTurn():e.B},v.prototype.setTurn=function(a){this.history.length&&this.position.setTurn(a)},v.prototype.getCaptureCount=function(){var a={};a[e.B]=0,a[e.W]=0;for(var b=0;b<this.history.length;b++)a[e.B]+=this.history[b].getCaptureCount(e.B),a[e.W]+=this.history[b].getCaptureCount(e.W);return a},v.prototype.getMoveVariation=function(a,b){return this.node?this.node.getMoveVariation(a,b):-1},v.prototype.get=function(a){if(a){"string"==typeof a&&(a=a.split("."));for(var b,c=this.info,d=0;d<a.length;d++){if(b=a[d],d+1==a.length)return c[b];if("object"!=typeof c[b])return void console.warn("Game property",b,"is not an object");c=c[b]}}},v.prototype.isOnBoard=function(a,b){return a>=0&&b>=0&&a<this.info.board.width&&b<this.info.board.height},v.prototype.isMoveVariation=function(a,b){return this.node?this.node.isMoveVariation(a,b):!1},v.prototype.isRepeatingPosition=function(a){var b;if("KO"==this.checkRepeat&&this.history.length-2>=0)b=this.history.length-2;else{if("ALL"!=this.checkRepeat)return!1;b=0}for(var c=this.history.length-2;c>=b;c--)if(a.isSameAs(this.history[c]))return!0;return!1},v.prototype.isValidMove=function(a,b,c){try{this.validateMove(a,b,c)}catch(d){return!1}return!0},v.prototype.validateMove=function(a,b,c,f){if(!this.isOnBoard(a,b))throw new l(d.error.POSTITION_OUT_OF_BOUNDS,a,b,c);if(this.position.stones.get(a,b)!=e.EMPTY)throw new l(d.error.POSTITION_ALREADY_HAS_STONE,a,b,c);c=c||this.position.getTurn(),f=f||this.position.clone(),f.stones.set(a,b,c);var g=f.captureAdjacent(a,b);if(!g&&!f.hasLiberties(a,b)){if(!this.allowSuicide)throw new l(d.error.POSTITION_IS_SUICIDE,a,b,c);f.captureGroup(a,b)}if(this.checkRepeat&&this.isRepeatingPosition(f,a,b))throw new l(d.error.POSTITION_IS_REPEATING,a,b,c);return f.setTurn(-c),f},v.prototype.validatePlacement=function(a,b,c,f){if(!this.isOnBoard(a,b))throw new l(d.error.POSTITION_OUT_OF_BOUNDS,a,b,c);if(f.stones.set(a,b,c),c!==e.EMPTY){var g=f.captureAdjacent(a,b);g||f.hasLiberties(a,b)||f.captureGroup(a,b)}},v.prototype.addStone=function(a,b,c){if(!this.position.stones.is(a,b,c)){var d=this.position.clone();if(this.validatePlacement(a,b,c,d),"undefined"==typeof this.node.setup){if(this.node.move){r.call(this);var e=new g,f=e.appendTo(this.node);this.node=e,this.path.advance(f)}this.node.setup=[]}t.call(this,d),this.node.setup.push(this.position.stones.get(a,b,"color"))}},v.prototype.addMarkup=function(a,b,c){"undefined"==typeof this.node.markup&&(this.node.markup=[]),this.position.markup.set(a,b,c),this.node.markup.push(this.position.markup.get(a,b,"type"))},v.prototype.removeStone=function(a,b){var c=!1;if("undefined"!=typeof this.node.setup)for(var d=0;d<this.node.setup.length;d++)if(a==this.node.setup[d].x&&b==this.node.setup[d].y){this.node.setup.splice(d,1),this.position.stones.unset(a,b),c=!0;break}c||this.addStone(a,b,e.EMPTY)},v.prototype.removeMarkup=function(a,b){if("undefined"!=typeof this.node.markup)for(var c=0;c<this.node.markup.length;c++)if(a==this.node.markup[c].x&&b==this.node.markup[c].y){this.node.markup.splice(c,1),this.position.markup.unset(a,b);break}},v.prototype.hasStone=function(a,b,c){return"undefined"!=typeof c?this.position.stones.is(a,b,c):this.position.stones.has(a,b)},v.prototype.hasMarkup=function(a,b,c){return"undefined"!=typeof c?this.position.markup.is(a,b,c):this.position.markup.has(a,b)},v.prototype.getStone=function(a,b){return this.position.stones.get(a,b)},v.prototype.getMarkup=function(a,b){return this.position.markup.get(a,b)},v.prototype.play=function(a,b,c){c=c||this.position.getTurn();var d=this.validateMove(a,b,c);r.call(this,d);var e=new g({move:{x:a,y:b,color:c}}),f=e.appendTo(this.node);return this.node._remembered_path=f,this.node=e,this.path.advance(f),!0},v.prototype.pass=function(a){a=a||this.position.getTurn();var b=this.position.clone();b.setTurn(-a),r.call(this,b);var c=new g({move:{pass:!0,color:a}}),d=c.appendTo(this.node);this.node._remembered_path=d,this.node=c,this.path.advance(d)},v.prototype.next=function(a){if("object"==typeof a&&(a=this.node.children.indexOf(a)),n.call(this,a))try{u.call(this)}catch(b){throw o.call(this),b}},v.prototype.previous=function(){o.call(this)&&s.call(this)},v.prototype.last=function(){for(;n.call(this);)try{u.call(this)}catch(a){throw o.call(this),a}},v.prototype.first=function(){p.call(this),q.call(this),u.call(this)},v.prototype.goto=function(a){if(null!==this.root&&"undefined"!=typeof a){"function"==typeof a&&(a=a.call(this));var b;if("number"==typeof a)b=this.path.clone(),b.setMove(a);else if("string"==typeof a){if(this.node.name==a)return;if(b=this.getPathToNode(a),null===b)return}else b=a;if(!this.path.compare(b)){p.call(this),q.call(this),r.call(this),u.call(this);for(var c=b.getMove(),d=0;c>d&&n.call(this,b.nodeAt(d));d++)try{u.call(this)}catch(e){throw o.call(this),e}}}},v.prototype.lastFork=function(){for(;execPrevious.call(this)&&1==this.node.children.length;);},v.prototype.getState=function(){if(!this.jgf||!this.path)return null;var a={jgf:this.jgf,path:this.path.clone()};return a},v.prototype.restoreState=function(a){a&&a.jgf&&a.path&&(this.load(a.jgf),this.goto(a.path))},v}]}),b.module("ngGo.Game.Node.Service",["ngGo"]).factory("GameNode",["StoneColor",function(a){var c="a".charCodeAt(0),d=function(a){return[a.charCodeAt(0)-c,a.charCodeAt(1)-c]},e=function(a,b){return b=b||{},""===a||"pass"==a?b.pass=!0:("string"==typeof a&&(a=d(a)),b.x=1*a[0],b.y=1*a[1]),b},f=function(b){return b==a.B?"B":b==a.W?"W":""},g=function(b){return"B"==b?a.B:"W"==b?a.W:a.E},h=function(a){var c=b.copy(a),d=f(a.color);return""===d?null:(c[d]=a.pass===!0?"pass":[a.x,a.y],delete c.x,delete c.y,delete c.color,c)},i=function(a){var b,c;return a.W?(b="W",c=a.W):a.B&&(b="B",c=a.B),c?e(c,{color:g(b)}):null},j=function(a){var b,c,d={};for(b in a)c=f(a[b].color)||"E","undefined"==typeof d[c]&&(d[c]=[]),d[c].push([a[b].x,a[b].y]);return d},k=function(a){var b,c,d,f=[];for(c in a){d=g(c);for(b in a[c])f.push(e(a[c][b],{color:d}))}return f},l=function(a){var b,c,d={};for(b in a)c=a[b].type,"undefined"==typeof d[c]&&(d[c]=[]),d[c].push("LB"==c?[a[b].x,a[b].y,a[b].text]:[a[b].x,a[b].y]);return d},m=function(a){var c,f,g=[];for(f in a)if("label"==f){for(c=0;c<a[f].length;c++)if(b.isArray(a[f][c])){if(2==a[f][c].length&&"string"==typeof a[f][c][0]){var h=a[f][c][1];a[f][c]=d(a[f][c][0]),a[f][c].push(h)}a[f][c].length<3||g.push(e(a[f][c],{type:f,text:a[f][c][2]}))}}else for(c in a[f])g.push(e(a[f][c],{type:f}));return g},n=function(b){switch(b){case a.W:return"W";case a.B:return"B";default:return""}},o=function(b){switch(b){case"W":return a.W;case"B":return a.B;default:return a.EMPTY}},p={toJgf:{move:h,setup:j,markup:l,turn:n},fromJgf:{move:i,setup:k,markup:m,turn:o}},q=function(a,b){if(this.parent=b||null,this.children=[],a)for(var c in a)this[c]=a[c]};return q.prototype.getChild=function(a){return a=a||0,this.children[a]?this.children[a]:null},q.prototype.getChildren=function(){return this.children},q.prototype.hasChildren=function(){return this.children.length>0},q.prototype.hasMoveVariations=function(){if(this.children.length<=1)return!1;for(var a=0,b=0;b<this.children.length;b++)if(this.children[b].move&&a++,a>1)return!0;return!1},q.prototype.getMoveVariations=function(){if(0===this.children.length)return!1;for(var a=[],b=0;b<this.children.length;b++)this.children[b].move&&a.push(this.children[b]);return a},q.prototype.getMoveVariation=function(a,b){for(var c in this.children)if(this.children[c].move&&this.children[c].move.x==a&&this.children[c].move.y==b)return c;return-1},q.prototype.isMoveVariation=function(a,b){for(var c in this.children)if(this.children[c].move&&this.children[c].move.x==a&&this.children[c].move.y==b)return!0;return!1},q.prototype.remove=function(){if(this.parent){var a=this.parent.children.indexOf(this);-1!==a&&this.parent.children.splice(a,1),this.parent=null}},q.prototype.moveUp=function(){if(this.parent){var a=this.parent.children.indexOf(this);if(a>0){var b=this.parent.children[a-1];this.parent.children[a-1]=this,this.parent.children[a]=b}}},q.prototype.moveDown=function(){if(this.parent){var a=this.parent.children.indexOf(this);if(-1!==a&&a<this.parent.children.length-1){var b=this.parent.children[a+1];this.parent.children[a+1]=this,this.parent.children[a]=b}}},q.prototype.appendTo=function(a){return this.remove(),this.parent=a,a.children.push(this),a.children.length-1},q.prototype.appendChild=function(a){return a.parent=this,this.children.push(a),this.children.length-1},q.prototype.insertNode=function(a){for(var b in this.children)this.children[b].parent=a;a.children=a.children.concat(this.children),a.parent=this,this.children=[a]},q.prototype.fromJgf=function(a,c){if("undefined"!=typeof a.tree)return q.fromJgf(a.tree,c);var d,e,f,g;for(c=c||this,f=0;f<a.length;f++){if(b.isArray(a[f]))for(g=0;g<a[f].length;g++)d=new q,d.fromJgf(a[f][g]),c.appendChild(d);else{var h=Object.getOwnPropertyNames(a[f]);for(var i in h){var j=h[i];c[j]="undefined"!=typeof p.fromJgf[j]?p.fromJgf[j](a[f][j]):"object"==typeof a[f][j]?b.copy(a[f][j]):a[f][j]}}f+1<a.length&&!b.isArray(a[f+1])&&(e=new q,c.appendChild(e),c=e)}},q.prototype.toJgf=function(a){a=a||[];var c={},d=Object.getOwnPropertyNames(this);for(var e in d){var f=d[e];"parent"!=f&&"children"!=f&&(c[f]="undefined"!=typeof p.toJgf[f]?p.toJgf[f](this[f]):"object"==typeof this[f]?b.copy(this[f]):this[f])}if(a.push(c),this.children.length>1){var g=[];a.push(g);for(var h in this.children){var i=[];g.push(i),this.children[h].toJgf(i)}}else 1==this.children.length&&this.children[0].toJgf(a);return a},q}]),b.module("ngGo.Game.Path.Service",["ngGo"]).factory("GamePath",function(){var a=function(){this.reset()};a.prototype.reset=function(){return this.move=0,this.path={},this.branches=0,this},a.prototype.advance=function(a){return a>0&&(this.path[this.move]=1,this.branches++),this.move++,this},a.prototype.retreat=function(){return 0!==this.move?(this.path[this.move]&&(delete this.path[this.move],this.branches--),this.move--,this):void 0},a.prototype.setMove=function(a){if(a<this.move)for(var b in this.path)b>a&&(delete this.path[b],this.branches--);return this.move=a,this},a.prototype.getMove=function(){return this.move},a.prototype.nodeAt=function(a){return"undefined"==typeof this.path[a]?0:this.path[a]},a.prototype.compare=function(a){if(a&&"object"==typeof a&&"undefined"!=typeof a.move){if(this.move!==a.move||this.branches!=a.branches)return!1;for(var b in this.path)if("undefined"==typeof a.path[b]||this.path[b]!=a.path[b])return!1;return!0}},a.prototype.clone=function(){var c=new a;return c.move=this.move,c.branches=this.branches,c.path=b.copy(this.path),c};var c=function(a,b,d){if(a.name&&a.name==b)return!0;for(var e=0;e<a.children.length;e++){if(d.advance(e),c(a.children[e],b,d))return!0;d.retreat()}return!1};return a.findNode=function(b,d){var e=new a;return c(d,b,e)?e:null},a}),b.module("ngGo.Game.Position.Service",["ngGo","ngGo.Board.Grid.Service"]).factory("GamePosition",["StoneColor","BoardGrid",function(a,b){var c=function(c,d){this.error=0,this.width=0,this.height=0,this.stones=new b,this.markup=new b,this.turn=a.B,this.captures={},this.captures[a.B]=[],this.captures[a.W]=[],this.stones.whenEmpty(a.EMPTY),(c||d)&&this.setSize(c,d)};return c.prototype.setSize=function(a,b){a=a||b||0,b=b||a||0,this.width=parseInt(a),this.height=parseInt(b),this.stones.setSize(a,b),this.markup.setSize(a,b),this.empty()},c.prototype.empty=function(){this.stones.empty(),this.markup.empty()},c.prototype.setStone=function(a,b,c){this.stones.set(a,b,c)},c.prototype.setMarkup=function(a,b,c){this.markup.set(a,b,c)},c.prototype.hasLiberties=function(c,d,e,f){if(!this.stones.isOnGrid(c,d))return!1;f=f||new b(this.width,this.height);var g=this.stones.get(c,d);return e=e||g,f.get(c,d)===!0||g===-e?!1:g===a.EMPTY?!0:(f.set(c,d,!0),this.hasLiberties(c,d-1,e,f)||this.hasLiberties(c,d+1,e,f)||this.hasLiberties(c-1,d,e,f)||this.hasLiberties(c+1,d,e,f))},c.prototype.captureAdjacent=function(b,c,d){if(!this.stones.isOnGrid(b,c))return!1;if(d=d||this.stones.get(b,c),d==a.EMPTY)return!1;var e=!1;return this.canCapture(b,c-1,-d,!0)&&(e=!0),this.canCapture(b,c+1,-d,!0)&&(e=!0),this.canCapture(b-1,c,-d,!0)&&(e=!0),this.canCapture(b+1,c,-d,!0)&&(e=!0),e},c.prototype.canCapture=function(b,c,d,e){return this.stones.isOnGrid(b,c)?this.stones.get(b,c)==a.EMPTY?!1:(d=d||this.stones.get(b,c),this.stones.get(b,c)!==d?!1:this.hasLiberties(b,c,d)?!1:(e&&this.captureGroup(b,c,d),!0)):!1},c.prototype.captureGroup=function(a,b,c){return this.stones.isOnGrid(a,b)?(c=c||this.stones.get(a,b),this.stones.get(a,b)!==c?!1:(this.captureStone(a,b),this.captureGroup(a,b-1,c),this.captureGroup(a,b+1,c),this.captureGroup(a-1,b,c),this.captureGroup(a+1,b,c),!0)):!1},c.prototype.captureStone=function(b,c){if(this.stones.isOnGrid(b,c)){var d=this.stones.get(b,c);d!==a.EMPTY&&(this.stones.set(b,c,a.EMPTY),this.captures[d].push({x:b,y:c}))}},c.prototype.setCaptures=function(a,b){this.captures[a]=b},c.prototype.getCaptures=function(a){return this.captures[a]||[]},c.prototype.getCaptureCount=function(a){return this.captures[-a].length},c.prototype.setTurn=function(a){this.turn=a},c.prototype.getTurn=function(){return this.turn},c.prototype.switchTurn=function(){this.turn=-this.turn},c.prototype.clone=function(){var a=new c;return a.turn=this.turn,a.width=this.width,a.height=this.height,a.stones=this.stones.clone(),a.markup=new b(this.width,this.height),a},c.prototype.isSameAs=function(a){return this.width!=a.width||this.height!=a.height?!1:this.stones.isSameAs(a.stones)},c}]),b.module("ngGo.Game.Score.Service",["ngGo"]).factory("GameScore",["StoneColor",function(a){var b=function(){return parseInt(this.stones)+parseInt(this.territory)+parseInt(this.captures)+parseInt(this.komi)},c=function(){var a=this;this.black={},this.white={},this.reset(),this.black.total=function(){return b.call(a.black)},this.white.total=function(){return b.call(a.white)}};return c.prototype.reset=function(){var a=["stones","territory","captures","komi"];for(var b in a)this.black[a[b]]=0,this.white[a[b]]=0},c.prototype.winner=function(){var b=this.black.total(),c=this.white.total();return c>b?a.W:b>c?a.B:a.E},c}]),b.module("ngGo.Game.Scorer.Service",["ngGo","ngGo.Game.Score.Service","ngGo.Board.Grid.Service"]).factory("GameScorer",["GameScore","StoneColor","BoardGrid",function(a,b,c){var d={UNKNOWN:b.EMPTY,BLACK_STONE:b.B,WHITE_STONE:b.W,BLACK_CANDIDATE:2*b.B,WHITE_CANDIDATE:2*b.W,NEUTRAL:3*b.B},e=function(a,b,c,d){var f=this.stones.get(a,b),g=this.game.position.stones.get(a,b);this.stones.isOnGrid(a,b)&&f!=c&&f!=d&&(2*g==c?this.stones.set(a,b,g):this.stones.set(a,b,c),e.call(this,a-1,b,c,d),e.call(this,a,b-1,c,d),e.call(this,a+1,b,c,d),e.call(this,a,b+1,c,d))},f=function(a,b){var c=this.game.position.stones.get(a,b);
this.stones.isOnGrid(a,b)&&this.stones.get(a,b)!=c&&(this.stones.set(a,b,c),f.call(this,a-1,b),f.call(this,a,b-1),f.call(this,a+1,b),f.call(this,a,b+1))},g=function(){for(var a,b,c,e,f,g,h,i,j=!0;j;)for(j=!1,h=0;h<this.stones.width;h++)for(i=0;i<this.stones.height;i++)if(a=this.stones.get(h,i),a==d.UNKNOWN||a==d.BLACK_CANDIDATE||a==d.WHITE_CANDIDATE){for(c=[this.stones.get(h-1,i),this.stones.get(h,i-1),this.stones.get(h+1,i),this.stones.get(h,i+1)],e=f=!1,g=0;4>g;g++)c[g]==d.BLACK_STONE||c[g]==d.BLACK_CANDIDATE?e=!0:c[g]==d.WHITE_STONE||c[g]==d.WHITE_CANDIDATE?f=!0:c[g]==d.NEUTRAL&&(e=f=!0);b=e&&f?d.NEUTRAL:e?d.BLACK_CANDIDATE:f?d.WHITE_CANDIDATE:!1,b!==!1&&b!=a&&(j=!0,this.stones.set(h,i,b))}},h={game:null,score:null,stones:null,captures:null,points:null,load:function(b){this.score=new a,this.game=b,this.stones=this.game.position.stones.clone(),this.captures=new c(this.stones.width,this.stones.height,this.stones.emptyValue),this.points=new c(this.stones.width,this.stones.height,this.stones.emptyValue)},getScore:function(){return this.score},getPoints:function(){return this.points},getCaptures:function(){return this.captures},calculate:function(){if(!this.game)return void console.warn("No game loaded in game scorer, can't calutlate score.");this.points.empty(),this.captures.empty(),g.call(this);var a=this.game.get("game.komi"),c=this.game.getCaptureCount();this.score.reset(),this.score.black.captures=c[b.B],this.score.white.captures=c[b.W],this.score.black.komi=0>a?a:0,this.score.white.komi=a>0?a:0;var e,f,h,i;for(e=0;e<this.stones.width;e++)for(f=0;f<this.stones.height;f++)h=this.stones.get(e,f),i=this.game.position.stones.get(e,f),h!=d.BLACK_STONE||i!=b.B?h!=d.WHITE_STONE||i!=b.W?h!=d.BLACK_CANDIDATE?h!=d.WHITE_CANDIDATE||(this.score.white.territory++,this.points.set(e,f,b.W),i==b.B&&(this.score.white.captures++,this.captures.set(e,f,b.B))):(this.score.black.territory++,this.points.set(e,f,b.B),i==b.W&&(this.score.black.captures++,this.captures.set(e,f,b.W))):this.score.white.stones++:this.score.black.stones++},mark:function(a,c){var g=this.game.position.stones.get(a,c),h=this.stones.get(a,c);g==b.W?h==d.WHITE_STONE?e.call(this,a,c,d.BLACK_CANDIDATE,d.BLACK_STONE):f.call(this,a,c):g==b.B&&(h==d.BLACK_STONE?e.call(this,a,c,d.WHITE_CANDIDATE,d.WHITE_STONE):f.call(this,a,c))}};return h}]),b.module("ngGo.Kifu.Blank.Service",["ngGo"]).factory("KifuBlank",["ngGo",function(a){var c={record:{application:a.name+" v"+a.version,version:1,charset:"UTF-8"},game:{type:"go",players:[{color:"black",name:"Black"},{color:"white",name:"White"}]},board:{width:19,height:19},tree:[]},d={AP:a.name+":"+a.version,CA:"UTF-8",FF:"4",GM:"1",SZ:"19",PB:"Black",PW:"White"},e={jgf:function(a){var d=b.copy(c);if(a)for(var e in a)d[e]=b.extend(d[e]||{},a[e]);return d},sgf:function(a){var c=b.copy(d);if(a)for(var e in a)c[e]=a[e];return c}};return e}]),b.module("ngGo.Kifu.Parser.Service",["ngGo","ngGo.Kifu.Parsers.Gib2Jgf.Service","ngGo.Kifu.Parsers.Sgf2Jgf.Service","ngGo.Kifu.Parsers.Jgf2Sgf.Service"]).constant("sgfAliases",{AP:"record.application",CA:"record.charset",CP:"record.copyright",SO:"record.source",US:"record.transcriber",AN:"record.annotator",GM:"game.type",GN:"game.name",KM:"game.komi",HA:"game.handicap",RE:"game.result",RU:"game.rules",TM:"game.time.main",OT:"game.time.overtime",DT:"game.dates",PC:"game.location",EV:"game.event",RO:"game.round",ON:"game.opening",GC:"game.comment",PB:"name",PW:"name",BT:"team",WT:"team",BR:"rank",WR:"rank",N:"name",C:"comments",CR:"circle",TR:"triangle",SQ:"square",MA:"mark",SL:"select",LB:"label"}).constant("sgfGames",{1:"go",2:"othello",3:"chess",4:"renju",6:"backgammon",7:"chinese chess",8:"shogi"}).factory("KifuParser",["Gib2Jgf","Sgf2Jgf","Jgf2Sgf",function(a,b,c){var d={gib2jgf:function(b,c){return a.parse(b,c)},sgf2jgf:function(a,c){return b.parse(a,c)},jgf2sgf:function(a){return c.parse(a)}};return d}]),b.module("ngGo.Kifu.Parsers.Gib2Jgf.Service",["ngGo","ngGo.Kifu.Blank.Service"]).factory("Gib2Jgf",["ngGo","KifuBlank",function(a,b){var c=/STO\s0\s([0-9]+)\s(1|2)\s([0-9]+)\s([0-9]+)/gi,d=/GAME(BLACK|WHITE)NAME=([A-Za-z0-9]+)\s\(([0-9]+D|K)\)/gi,e=/GAMEGONGJE=([0-9]+)/gi,f=/GAMEDATE=([0-9]+)-\s?([0-9]+)-\s?([0-9]+)/g,g=/GAMERESULT=(white|black)\s([0-9]+\.?[0-9]?)/gi,h=/GAMERESULT=(white|black)\s[a-z\s]+(resignation|time)/gi,i=function(a,b){"undefined"==typeof a.game.players&&(a.game.players=[]);for(var c="BLACK"==b[1].toUpperCase()?"black":"white",d={color:c,name:b[2],rank:b[3].toLowerCase()},e=0;e<a.game.players.length;e++)if(a.game.players[e].color==c)return void(a.game.players[e]=d);a.game.players.push(d)},j=function(a,b){a.game.komi=parseFloat(b[1]/10)},k=function(a,b){"undefined"==typeof a.game.dates&&(a.game.dates=[]),a.game.dates.push(b[1]+"-"+b[2]+"-"+b[3])},l=function(a,b){var c="black"==b[1].toLowerCase()?"B":"W";c+="+",c+=b[2].match(/res/i)?"R":b[2].match(/time/i)?"T":b[2],a.game.result=c},m=function(a,b,c){var d=c[2];if(1==d)d="B";else{if(2!=d)return;d="W"}b.move={},b.move[d]=[1*c[3],1*c[4]]},n={parse:function(a){var n,o=b.jgf(),p=o.tree,q={root:!0};for(p.push(q);n=d.exec(a);)i(o,n);for((n=e.exec(a))&&j(o,n),(n=f.exec(a))&&k(o,n),((n=g.exec(a))||(n=h.exec(a)))&&l(o,n);n=c.exec(a);)q={},m(o,q,n),p.push(q);return o}};return n}]),b.module("ngGo.Kifu.Parsers.Jgf2Sgf.Service",["ngGo","ngGo.Kifu.Blank.Service"]).factory("Jgf2Sgf",["ngGo","sgfAliases","sgfGames","KifuBlank",function(a,c,d,e){var f={};for(var g in c)f[c[g]]=g;var h="a".charCodeAt(0),i=function(a){return String.fromCharCode(h+a[0])+String.fromCharCode(h+a[1])},j=function(a){return"string"==typeof a?a.replace(/\\/g,"\\\\").replace(/]/g,"\\]"):a},k=function(a,b,c,d){if(b.length){c.sgf+=a;for(var e=0;e<b.length;e++)c.sgf+="["+(d?j(b[e]):b[e])+"]"}},l=function(a,b){var c=a.B?"B":a.W?"W":"";if(""!==c){var d="pass"==a[c]?"":a[c];b.sgf+=c+"["+i(d)+"]"}},m=function(a,b){for(var c in a){for(var d=0;d<a[c].length;d++)a[c][d]=i(a[c][d]);k("A"+c,a[c],b)}},n=function(a,b){for(var c in a){for(var d=0;d<a[c].length;d++)a[c][d]=i(a[c][d]);k("T"+c,a[c],b)}},o=function(a,b){for(var c in a){var d;if("label"==c)for(d=0;d<a[c].length;d++)a[c][d]=i(a[c][d])+":"+a[c][d][2];else for(d=0;d<a[c].length;d++)a[c][d]=i(a[c][d]);"undefined"!=typeof f[c]&&(c=f[c]),k(c,a[c],b)}},p=function(a,b){b.sgf+="PL["+a+"]"},q=function(a,b){for(var c="undefined"!=typeof f.comments?f.comments:"C",d=[],e=0;e<a.length;e++)"string"==typeof a[e]?d.push(a[e]):a[e].comment&&d.push(a[e].comment);k(c,d,b,!0)},r=function(a,b){var c="undefined"!=typeof f.name?f.name:"N";b.sgf+=c+"["+j(a)+"]"},s=function(a){for(var b in d)if(d[b]==a)return b;return 0},t=function(a){var b=a.split(" v");return b.length>1?b[0]+":"+b[1]:a},u=function(a,b){var c=0;a.variation_markup||(c+=2),a.variation_siblings&&(c+=1),b.ST=c},v=function(a,b){b.SZ=a.width&&a.height?a.width==a.height?a.width:a.width+":"+a.height:a.width?a.width:a.height?a.height:""},w=function(a,b){for(var c=0;c<a.length;c++)if(a[c].color&&("black"==a[c].color||"white"==a[c].color)){var d="black"==a[c].color?"B":"W";a[c].name&&(b["P"+d]=a[c].name),a[c].rank&&(b[d+"R"]=a[c].rank),a[c].team&&(b[d+"T"]=a[c].team)}},x={move:l,setup:m,score:n,markup:o,turn:p,comments:q,name:r,"record.application":t,player:u,board:v,"game.type":s,"game.players":w},y=function(a,c){for(var d=0;d<a.length;d++){var e=a[d];if(b.isArray(e))for(var f=0;f<e.length;f++)c.sgf+="(\n;",y(e[f],c),c.sgf+="\n)";else{for(var g in e)"undefined"==typeof x[g]?"object"!=typeof props[g]&&(c.sgf+=g+"["+j(e[g])+"]"):x[g](e[g],c);d+1<a.length&&(c.sgf+="\n;")}}},z=function(a,b,c){"undefined"==typeof c&&(c="");for(var d in a)if("sgf"!=d){var e=""===c?d:c+"."+d;if("object"!=typeof a[d]){var g;"undefined"!=typeof f[e]&&(g="undefined"!=typeof x[e]?x[e](a[d]):j(a[d]),b[f[e]]=g)}else"undefined"!=typeof x[e]?x[e](a[d],b):z(a[d],b,e)}},A={parse:function(a){if("string"==typeof a&&(a=b.fromJson(a)),!a.tree)return void console.error("No moves tree in JGF object");var c={sgf:"(\n;"},d=b.copy(a),f=e.sgf();a.tree&&a.tree.length>0&&a.tree[0].root&&(d=b.extend(d,a.tree[0]),delete d.root,delete a.tree[0]),delete d.tree,z(d,f);for(var g in f)f[g]&&(c.sgf+=g+"["+j(f[g])+"]");return y(a.tree,c),c.sgf+=")",c.sgf}};return A}]),b.module("ngGo.Kifu.Parsers.Sgf2Jgf.Service",["ngGo","ngGo.Kifu.Blank.Service"]).factory("Sgf2Jgf",["ngGo","sgfAliases","sgfGames","KifuBlank",function(a,c,d,e){var f=/\(|\)|(;(\s*[A-Z]+\s*((\[\])|(\[(.|\s)*?([^\\]\])))+)*)/g,g=/[A-Z]+\s*((\[\])|(\[(.|\s)*?([^\\]\])))+/g,h=/[A-Z]+/,i=/(\[\])|(\[(.|\s)*?([^\\]\]))/g,j="a".charCodeAt(0),k=function(a){return[a.charCodeAt(0)-j,a.charCodeAt(1)-j]},l=function(a,b,c,d){if(!a.record.application){var e=d[0].split(":");a.record.application=e.length>1?e[0]+" v"+e[1]:e[0]}},m=function(){},n=function(a,b,c,e){var f=e[0];a.game.type="undefined"!=typeof d[f]?d[f]:e[0]},o=function(a,b,c,d){b.move={},b.move[c]=""===d[0]||a.width<=19&&"tt"==d[0]?"pass":k(d[0])},p=function(a,b,d,e){"undefined"!=typeof c[d]&&(d=c[d]),b[d]=e},q=function(a,b,d,e){"undefined"!=typeof c[d]&&(d=c[d]),b[d]=e[0]},r=function(a,b,c,d){"undefined"==typeof b.setup&&(b.setup={}),c=c.charAt(1),"undefined"==typeof b.setup[c]&&(b.setup[c]=[]);for(var e=0;e<d.length;e++)b.setup[c].push(k(d[e]))},s=function(a,b,c,d){"undefined"==typeof b.score&&(b.score={B:[],W:[]}),c=c.charAt(1);for(var e=0;e<d.length;e++)b.score[c].push(k(d[e]))},t=function(a,b,c,d){b.turn=d[0]},u=function(a,b,d,e){"undefined"!=typeof c[d]&&(d=c[d]),"undefined"==typeof b.markup&&(b.markup={}),"undefined"==typeof b.markup[d]&&(b.markup[d]=[]);for(var f=0;f<e.length;f++){var g=k(e[f].substr(0,2));g.push(e[f].substr(3)),b.markup[d].push(g)}},v=function(a,b,d,e){"undefined"!=typeof c[d]&&(d=c[d]),"undefined"==typeof b.markup&&(b.markup={}),"undefined"==typeof b.markup[d]&&(b.markup[d]=[]);for(var f in e)b.markup[d].push(k(e[f]))},w=function(a,b,c,d){"undefined"==typeof a.board&&(a.board={});var e=d[0].split(":");e.length>1?(a.board.width=parseInt(e[0]),a.board.height=parseInt(e[1])):a.board.width=a.board.height=parseInt(e[0])},x=function(a,b,c,d){"undefined"==typeof a.game.dates&&(a.game.dates=[]);for(var e=d[0].split(","),f=0;f<e.length;f++)a.game.dates.push(e[f])},y=function(a,b,c,d){a.game.komi=parseFloat(d[0])},z=function(a,b,c,d){"undefined"==typeof a.player&&(a.player={}),a.player.variation_markup=!1,a.player.variation_children=!1,a.player.variation_siblings=!1;var e=parseInt(d[0]);switch(e){case 0:a.player.variation_markup=!0,a.player.variation_children=!0;break;case 1:a.player.variation_markup=!0,a.player.variation_siblings=!0;break;case 2:a.player.variation_children=!0;break;case 3:a.player.variation_siblings=!0}},A=function(a,b,d,e){"undefined"==typeof a.game.players&&(a.game.players=[]);var f="PB"==d||"BT"==d||"BR"==d?"black":"white";"undefined"!=typeof c[d]&&(d=c[d]);for(var g=0;g<a.game.players.length;g++)if(a.game.players[g].color==f)return void(a.game.players[g][d]=e[0]);var h={color:f};h[d]=e[0],a.game.players.push(h)},B={AP:l,FF:m,GM:n,SZ:w,KM:y,DT:x,ST:z,PB:A,PW:A,BT:A,WT:A,BR:A,WR:A,B:o,W:o,C:p,N:q,AB:r,AW:r,AE:r,PL:t,TW:s,TB:s,CR:v,SQ:v,TR:v,MA:v,SL:v,LB:u},C=["B","W","C","N","AB","AW","AE","PL","LB","CR","SQ","TR","MA","SL","TW","TB"],D=function(a,b,c){if("object"==typeof b){for(var d,e=a,f=0;f<b.length&&(d=b[f],f+1!=b.length);f++)"object"!=typeof e[d]&&(e[d]={}),e=e[d];e[d]=c}},E={parse:function(a){var d=e.jgf({record:{sgf:{}}}),j=[],k=d.tree,l={root:!0};k.push(l);var m=a.match(f);for(var n in m)if("("!=m[n])if(")"!=m[n]){var o=m[n].match(g)||[];for(var p in o){var q=h.exec(o[p])[0].toUpperCase(),r=o[p].match(i);for(var s in r)r[s]=r[s].substring(1,r[s].length-1).replace(/\\(?!\\)/g,"");"undefined"==typeof B[q]?(1==r.length&&(r=r[0]),"undefined"==typeof c[q]?l?l[q]=r:d[q]=r:D(d,c[q].split("."),r)):(-1!==C.indexOf(q)&&(l&&"B"!=q&&"W"!=q||(l={},k.push(l))),B[q](d,l,q,r))}l&&!l.root&&(l=null)}else j.length&&(k=j.pop());else{if(0===n||"0"===n)continue;j.push(k),b.isArray(k[k.length-1])||k.push([]),k=k[k.length-1],k.push([]),k=k[k.length-1]}return d}};return E}]),b.module("ngGo",[]).constant("ngGo",{name:"ngGo",version:"1.1.1",error:{POSITION_OUT_OF_BOUNDS:1,POSITION_ALREADY_HAS_STONE:2,POSITION_IS_SUICIDE:3,POSITION_IS_REPEATING:4,NO_DATA:5,UNKNOWN_DATA:6,INVALID_SGF:7,INVALID_GIB:8,INVALID_JGF_JSON:9,INVALID_JGF_TREE_JSON:10}}).constant("StoneColor",{E:0,EMPTY:0,B:1,BLACK:1,W:-1,WHITE:-1}).constant("MarkupTypes",{TRIANGLE:"triangle",CIRCLE:"circle",SQUARE:"square",MARK:"mark",SELECT:"select",LABEL:"label",LAST:"last",SAD:"sad",HAPPY:"happy"}).constant("PlayerModes",{PLAY:"play",REPLAY:"replay",EDIT:"edit",SOLVE:"solve"}).constant("PlayerTools",{NONE:"none",MOVE:"move",SCORE:"score",SETUP:"setup",MARKUP:"markup"}).constant("KeyCodes",{LEFT:37,RIGHT:39,UP:38,DOWN:40,ESC:27,ENTER:13,SPACE:32,TAB:9,SHIFT:16,CTRL:17,ALT:18,HOME:36,END:35,PAGEUP:33,PAGEDOWN:34}),b.module("ngGo.Player.Directive",["ngGo.Board.Directive"]).directive("player",["Player",function(a){return{restrict:"E",controller:["$scope",function(b){b.Player||(b.Player=a)}],link:function(b,c,d){a.linkElement(c),d.$observe("mode",function(b){a.switchMode(b)}),d.$observe("tool",function(b){a.switchTool(b)}),d.$observe("variationMarkup",function(b){a.setVariationMarkup("true"===b)}),d.$observe("solutionPaths",function(b){a.toggleSolutionPaths("true"===b)}),d.$observe("lastMoveMarker",function(b){a.setLastMoveMarker(b)})}}}]),b.module("ngGo.Player.Service",["ngGo","ngGo.Player.Directive","ngGo.Player.Mode.Common.Service","ngGo.Board.Service","ngGo.Game.Service","ngGo.Game.Scorer.Service"]).provider("Player",["PlayerModes","PlayerTools","MarkupTypes",function(c,d,e){var f={mode:c.REPLAY,tool:d.MOVE,arrow_keys_navigation:!0,scroll_wheel_navigation:!0,last_move_marker:e.LAST,variation_markup:!0,variation_children:!0,variation_siblings:!1};this.setConfig=function(a){f=b.extend(f,a)},this.$get=["$rootScope","$document","Game","GameScorer","Board","PlayerTools",function(c,d,e,g,h,i){var j=function(b,c){if(!this.board||!c)return b.x=-1,void(b.y=-1);var d=0,e=0;"undefined"!=typeof c.offsetX?d=c.offsetX:c.originalEvent&&"undefined"!=typeof c.originalEvent.offsetX?d=c.originalEvent.offsetX:c.originalEvent&&"undefined"!=typeof c.originalEvent.layerX&&(d=c.originalEvent.layerX),"undefined"!=typeof c.offsetY?e=c.offsetY:c.originalEvent&&"undefined"!=typeof c.originalEvent.offsetY?e=c.originalEvent.offsetY:c.originalEvent&&"undefined"!=typeof c.originalEvent.layerY&&(e=c.originalEvent.layerY),d*=a.devicePixelRatio||1,e*=a.devicePixelRatio||1,b.x=this.board.getGridX(d),b.y=this.board.getGridY(e),c.drag&&(b.drag=c.drag)},k={config:{},board:null,game:null,modes:{},tools:[],mode:"",tool:"",path:null,init:function(){this.board=null,this.game=new e,this.path=null,this.mode="",this.tool="",this.arrowKeysNavigation=!1,this.scrollWheelNavigation=!1,this.lastMoveMarker="",this.variationMarkup=!1,this.variationChildren=!1,this.variationSiblings=!1,this.restrictNodeStart=null,this.restrictNodeEnd=null,this.parseConfig()},linkElement:function(a){this.element=a,this.registerElementEvent("keydown",d),this.registerElementEvent("click"),this.registerElementEvent("mousedown"),this.registerElementEvent("mouseup"),this.registerElementEvent("mousemove"),this.registerElementEvent("mouseout"),this.registerElementEvent("mousewheel"),this.registerElementEvent("wheel")},parseConfig:function(a){this.config=b.extend({},f,a||{}),this.switchMode(this.config.mode),this.switchTool(this.config.tool),this.setArrowKeysNavigation(this.config.arrow_keys_navigation),this.setScrollWheelNavigation(this.config.scroll_wheel_navigation),this.setLastMoveMarker(this.config.last_move_marker),this.setVariationMarkup(this.config.variation_markup,this.config.variation_children,this.config.variation_siblings);for(var c in this.modes)this.modes[c].parseConfig&&this.modes[c].parseConfig.call(this,this.config)},setArrowKeysNavigation:function(a){a!=this.arrowKeysNavigation&&(this.arrowKeysNavigation=a,this.broadcast("settingChange","arrowKeysNavigation"))},setScrollWheelNavigation:function(a){a!=this.scrollWheelNavigation&&(this.scrollWheelNavigation=a,this.broadcast("settingChange","scrollWheelNavigation"))},setLastMoveMarker:function(a){a!=this.lastMoveMarker&&(this.lastMoveMarker=a,this.broadcast("settingChange","lastMoveMarker"))},setVariationMarkup:function(a,b,c){var d=!1;a!=this.variationMarkup&&(this.variationMarkup=a,d=!0),"undefined"!=typeof b&&b!=this.variationChildren&&(this.variationChildren=b,d=!0),"undefined"!=typeof c&&c!=this.variationSiblings&&(this.variationSiblings=c,d=!0),d&&this.broadcast("settingChange","variationMarkup")},registerMode:function(a,b){this.modes[a]=b,this.modes[a].parseConfig&&this.modes[a].parseConfig.call(this,this.config),this.mode==a&&(this.switchMode(this.mode,!0),this.switchTool(this.tool,!0))},setTools:function(a){this.tools=a||[i.NONE]},hasMode:function(a){return this.modes[a]?!0:!1},hasTool:function(a){return-1!=this.tools.indexOf(a)},switchMode:function(a,b){return b||a&&this.mode!=a?(this.mode&&this.broadcast("modeExit",this.mode),this.mode=a,this.tools=[],this.tool=i.NONE,this.broadcast("modeEnter",this.mode),!0):!1},switchTool:function(a,b){return b||a&&this.tool!=a?this.mode&&this.modes[this.mode]&&-1===this.tools.indexOf(a)?!1:(this.tool=a,this.broadcast("toolSwitch",this.tool),!0):!1},saveState:function(){this.playerState={mode:this.mode,tool:this.tool,restrictNodeStart:this.restrictNodeStart,restrictNodeEnd:this.restrictNodeEnd},this.saveGameState()},restoreState:function(){this.playerState&&(this.switchMode(this.playerState.mode),this.switchTool(this.playerState.tool),this.restrictNodeStart=this.playerState.restrictNodeStart,this.restrictNodeEnd=this.playerState.restrictNodeEnd,this.restoreGameState())},load:function(a,b){try{this.game.load(a)}catch(c){throw c}return this.path=null,(b||"undefined"==typeof b)&&this.parseConfig(this.game.get("settings")),this.broadcast("gameLoaded",this.game),this.board&&(this.board.removeAll(),this.board.parseConfig(this.game.get("board")),this.processPosition()),!0},reload:function(){this.game&&this.game.isLoaded()&&(this.game.reload(),this.board&&(this.board.removeAll(),this.processPosition()))},saveGameState:function(){this.game&&this.game.isLoaded()&&(this.gameState=this.game.getState())},restoreGameState:function(){this.game&&this.gameState&&(this.game.restoreState(this.gameState),this.board&&(this.board.removeAll(),this.processPosition()))},next:function(a){this.game&&this.game.node!=this.restrictNodeEnd&&(this.game.next(a),this.processPosition())},previous:function(){this.game&&this.game.node!=this.restrictNodeStart&&(this.game.previous(),this.processPosition())},last:function(){this.game&&(this.game.last(),this.processPosition())},first:function(){this.game&&(this.game.first(),this.processPosition())},"goto":function(a){this.game&&a&&(this.game.goto(a),this.processPosition())},restrictNode:function(a){this.game&&this.game.node&&(a?this.restrictNodeEnd=this.game.node:this.restrictNodeStart=this.game.node)},processPosition:function(){if(this.game&&this.game.isLoaded()){var a=this.game.getNode(),b=this.game.getPath(),c=this.game.getPosition(),d=!b.compare(this.path);this.updateBoard(a,c,d),d&&(this.path=b.clone(),this.broadcast("pathChange",a),a.name&&this.broadcast("reachedNode."+a.name,a)),a.move&&a.move.pass&&this.broadcast("movePassed",a)}},newGame:function(){this.game=new e,this.processPosition()},scoreGame:function(){g.calculate();var a=g.getScore(),b=g.getPoints(),c=g.getCaptures();this.board.layers.markup.removeAll(),this.board.layers.score.setAll(b,c),this.broadcast("scoreCalculated",a)},getBoard:function(){return this.board},setBoard:function(a){this.board=a,this.board&&this.broadcast("boardReady",this.board),this.game&&this.game.isLoaded()&&(this.board.removeAll(),this.board.parseConfig(this.game.get("board")),this.processPosition())},updateBoard:function(a,b,c){this.board&&(this.board.updatePosition(b,c),this.lastMoveMarker&&a.move&&!a.move.pass&&this.board.add("markup",a.move.x,a.move.y,this.lastMoveMarker),this.broadcast("boardUpdate",a))},registerElementEvent:function(a,b){"undefined"!=typeof b&&b.on||(b=this.element),b.off(a),b.on(a,this.broadcast.bind(this,a))},on:function(a,b,e,f){if("function"!=typeof b)return void console.warn("Listener is not a function:",b);e&&e.$parent&&(f=e,e="");{if(-1===a.indexOf(" ")){var g=this,h=f||c;return h.$on("ngGo.player."+a,function(){if(!(e&&("string"==typeof e&&e!=g.mode||-1===e.indexOf(g.mode))||"keydown"==a&&d[0].querySelector(":focus"))){if(("click"==a||"hover"==a||"mouse"==a.substr(0,5))&&j.call(g,arguments[0],arguments[1]),g.preventClickEvent&&"click"==a)return void delete g.preventClickEvent;"mousedrag"==a&&(g.preventClickEvent=!0),b.apply(g,arguments)}})}for(var i=a.split(" "),k=0;k<i.length;k++)this.on(i[k],b,e,f)}},broadcast:function(a,b){a&&(c.$$phase?c.$broadcast("ngGo.player."+a,b):c.$apply(function(){c.$broadcast("ngGo.player."+a,b)}))}};return k.init(),k}]}]),b.module("ngGo.Player.Mode.Common.Service",["ngGo","ngGo.Game.Scorer.Service"]).run(["Player","PlayerModes","PlayerModeCommon",function(a,b,c){a.on("keydown",c.keyDown,[b.REPLAY,b.EDIT]),a.on("mousewheel wheel",c.mouseWheel,[b.REPLAY,b.EDIT]),a.on("mousemove",c.mouseMove,[b.REPLAY,b.EDIT,b.SOLVE]),a.on("mouseout",c.mouseOut,[b.REPLAY,b.EDIT,b.SOLVE]),a.on("mousedown",c.mouseDown,[b.REPLAY,b.EDIT,b.SOLVE]),a.on("mouseup",c.mouseUp,[b.REPLAY,b.EDIT,b.SOLVE])}]).factory("PlayerModeCommon",["Player","PlayerTools","GameScorer","KeyCodes",function(a,c,e,f){var g=function(a){var b={start:{x:this.mouse.dragStart.x>a.x?a.x:this.mouse.dragStart.x,y:this.mouse.dragStart.y>a.y?a.y:this.mouse.dragStart.y},stop:{x:this.mouse.dragStart.x>a.x?this.mouse.dragStart.x:a.x,y:this.mouse.dragStart.y>a.y?this.mouse.dragStart.y:a.y}};return b.start.x<0&&(b.start.x=0),b.start.y<0&&(b.start.y=0),b.stop.x>this.board.width-1&&(b.stop.x=this.board.width-1),b.stop.y>this.board.height-1&&(b.stop.y=this.board.height-1),b};b.extend(a,{mouse:{dragStart:null,lastX:-1,lastY:-1}});var h={keyDown:function(a,b){if(this.game&&this.game.isLoaded())switch(b.keyCode){case f.ESC:this.mouse.dragStart=null,this.preventClickEvent=!0;break;case f.RIGHT:this.arrowKeysNavigation&&(b.preventDefault(),this.tool==c.MOVE&&this.game.node!=this.restrictNodeEnd&&this.next());break;case f.LEFT:this.arrowKeysNavigation&&(b.preventDefault(),this.tool==c.MOVE&&this.game.node!=this.restrictNodeStart&&this.previous());break;case f.UP:break;case f.DOWN:}},mouseWheel:function(a,b){if(!this.scrollWheelNavigation||this.tool!=c.MOVE)return!0;if(!this.game||!this.game.isLoaded())return!0;b=d(b);var e=b.mouseWheelY||b.deltaY;0>e?(this.board&&this.board.removeAll("hover"),this.next()):e>0&&(this.board&&this.board.removeAll("hover"),this.previous()),0!==e&&b.preventDefault()},mouseOut:function(){this.board&&this.board.removeAll("hover")},mouseMove:function(a,b){!this.mouse.dragStart||this.mouse.dragStart.x==a.x&&this.mouse.dragStart.y==a.y||(b.drag=g.call(this,a)),this.board&&this.board.layers.hover&&(this.mouse.lastX!=a.x||this.mouse.lastY!=a.y)&&(this.mouse.lastX=a.x,this.mouse.lastY=a.y,this.broadcast("hover",b))},mouseDown:function(a){this.mouse.dragStart={x:a.x,y:a.y}},mouseUp:function(a,b){!this.mouse.dragStart||this.mouse.dragStart.x==a.x&&this.mouse.dragStart.y==a.y||(b.drag=g.call(this,a),this.broadcast("mousedrag",b)),this.mouse.dragStart=null}};return h}]),b.module("ngGo.Player.Mode.Edit.Service",["ngGo","ngGo.Game.Scorer.Service"]).constant("SetupTools",{BLACK:"black",WHITE:"white",CLEAR:"clear"}).constant("MarkupTools",{TRIANGLE:"triangle",CIRCLE:"circle",SQUARE:"square",MARK:"mark",SELECT:"select",SAD:"sad",HAPPY:"happy",TEXT:"text",NUMBER:"number",CLEAR:"clear"}).run(["Player","PlayerModes","PlayerModeEdit",function(a,b,c){a.on("pathChange",c.pathChange,b.EDIT),a.on("toolSwitch",c.toolSwitch,b.EDIT),a.on("modeEnter",c.modeEnter,b.EDIT),a.on("mousedrag",c.mouseDrag,b.EDIT),a.on("keydown",c.keyDown,b.EDIT),a.on("click",c.click,b.EDIT),a.on("hover",c.hover,b.EDIT),a.registerMode(b.EDIT,c)}]).provider("PlayerModeEdit",function(){var a={};this.setConfig=function(c){a=b.extend(a,c)},this.$get=["Player","PlayerTools","SetupTools","MarkupTools","MarkupTypes","GameScorer","StoneColor","KeyCodes",function(a,c,d,e,f,g,h){var i="A".charCodeAt(0),j="a".charCodeAt(0),k=function(a,b,g){if(("undefined"==typeof a||"undefined"==typeof b)&&(a=this.mouse.lastX,b=this.mouse.lastY),this.board&&this.board.isOnBoard(a,b))switch(this.tool){case c.SETUP:this.setupTool==d.CLEAR?this.game.hasStone(a,b)&&this.board.add("hover",a,b,{type:"markup",value:f.MARK}):this.game.hasStone(a,b,this.setupToolColor())?g||this.board.add("hover",a,b,{type:"markup",value:f.MARK}):this.board.add("hover",a,b,{type:"stones",value:this.setupToolColor()});break;case c.MARKUP:this.markupTool==e.CLEAR||this.game.hasMarkup(a,b)?this.game.hasMarkup(a,b)&&this.board.add("hover",a,b,{type:"markup",value:f.MARK}):this.markupTool==e.TEXT||this.markupTool==e.NUMBER?this.board.add("hover",a,b,{type:"markup",value:{type:f.LABEL,text:this.markupLabel}}):this.board.add("hover",a,b,{type:"markup",value:this.markupTool});break;case c.MOVE:!this.game.hasStone(a,b)&&this.game.isValidMove(a,b)&&this.board.add("hover",a,b,{type:"stones",value:this.game.getTurn()});break;case c.SCORE:this.game.hasStone(a,b)&&this.board.add("hover",a,b,{type:"markup",value:f.MARK})}},l=function(a,b){if(this.game.hasMarkup(a,b)){var c=this.game.getMarkup(a,b);if(c.type==f.LABEL&&c.text){var d=this.markupLabels.indexOf(c.text);-1!=d&&this.markupLabels.splice(d,1)}return void this.game.removeMarkup(a,b)}this.markupTool!=e.CLEAR&&(this.markupTool==e.TEXT?(this.game.addMarkup(a,b,{type:f.LABEL,text:this.markupLabel}),this.markupLabels.push(this.markupLabel),this.determineMarkupLabel()):this.markupTool==e.NUMBER?(this.game.addMarkup(a,b,{type:f.LABEL,text:this.markupLabel}),this.markupLabels.push(this.markupLabel),this.determineMarkupLabel()):this.game.addMarkup(a,b,this.markupTool))},m=function(a,b,c){var d=this.setupToolColor();if(d===h.EMPTY)this.game.removeStone(a,b);else{if(!c&&this.game.hasStone(a,b,d))return void this.game.removeStone(a,b);this.game.hasStone(a,b)&&this.game.removeStone(a,b),this.game.addStone(a,b,d)}this.board.layers.markup.redrawCell(a,b)},n=function(){if(this.markupLabels=[],this.game&&this.game.isLoaded())for(var a=this.game.position.markup.all("type"),b=0;b<a.length;b++)a[b].type==f.LABEL&&""!==a[b].text&&this.markupLabels.push(a[b].text)};b.extend(a,{setupTool:d.BLACK,markupTool:e.TRIANGLE,markupLabels:[],markupLabel:"",switchSetupTool:function(a){this.setupTool=a},switchMarkupTool:function(a){this.markupTool=a,(this.markupTool==e.TEXT||this.markupTool==e.NUMBER)&&this.determineMarkupLabel()},setupToolColor:function(){switch(this.setupTool){case d.BLACK:return h.B;case d.WHITE:return h.W;default:return h.EMPTY}},setMarkupLabel:function(a){a&&(this.markupLabel=a)},determineMarkupLabel:function(){switch(this.markupLabel="",this.markupTool){case e.TEXT:for(var a=0;!this.markupLabel||-1!=this.markupLabels.indexOf(this.markupLabel);)this.markupLabel=26>a?String.fromCharCode(i+a):52>a?String.fromCharCode(j+a-26):String.fromCharCode(i+Math.floor(a/26)-2)+String.fromCharCode(i+a%26),a++;break;case e.NUMBER:for(this.markupLabel=0;0===this.markupLabel||-1!=this.markupLabels.indexOf(this.markupLabel);)this.markupLabel++}}});var o={hover:function(a){if(this.board){if(this.board.removeAll("hover"),!a.drag||this.tool!=c.SETUP&&this.tool!=c.MARKUP)return void k.call(this);if(this.markupTool==e.TEXT||this.markupTool==e.NUMBER)return void k.call(this);for(var b=a.drag.start.x;b<=a.drag.stop.x;b++)for(var d=a.drag.start.y;d<=a.drag.stop.y;d++)k.call(this,b,d,!0)}},keyDown:function(a,b){b.keyCode},click:function(a){if(this.board&&this.board.isOnBoard(a.x,a.y)){switch(this.board.removeAll("hover"),this.tool){case c.MOVE:if(!this.game.play(a.x,a.y))return;this.processPosition();break;case c.SETUP:m.call(this,a.x,a.y),this.processPosition();break;case c.MARKUP:l.call(this,a.x,a.y),this.processPosition();break;case c.SCORE:g.mark(a.x,a.y),this.scoreGame()}o.hover.call(this,a)}},mouseDrag:function(a){var b,d;switch(this.board&&this.board.removeAll("hover"),this.tool){case c.SETUP:for(b=a.drag.start.x;b<=a.drag.stop.x;b++)for(d=a.drag.start.y;d<=a.drag.stop.y;d++)m.call(this,b,d,!0);this.processPosition();break;case c.MARKUP:if(this.markupTool==e.TEXT||this.markupTool==e.NUMBER)break;for(b=a.drag.start.x;b<=a.drag.stop.x;b++)for(d=a.drag.start.y;d<=a.drag.stop.y;d++)l.call(this,b,d);this.processPosition()}o.hover.call(this,a)},pathChange:function(){n.call(this)},modeEnter:function(){this.setTools([c.MOVE,c.SETUP,c.MARKUP,c.SCORE]),this.tool=this.tools[0],n.call(this)},toolSwitch:function(){this.tool==c.SCORE?(this.statePreScoring=this.board.getState(),g.load(this.game),this.scoreGame()):this.statePreScoring&&(this.board.restoreState(this.statePreScoring),delete this.statePreScoring)}};return o}]}),b.module("ngGo.Player.Mode.Replay.Service",["ngGo","ngGo.Game.Scorer.Service"]).run(["Player","PlayerModes","PlayerModeReplay",function(a,b,c){a.on("settingChange",c.settingChange,b.REPLAY),a.on("boardUpdate",c.boardUpdate,b.REPLAY),a.on("pathChange",c.pathChange,b.REPLAY),a.on("toolSwitch",c.toolSwitch,b.REPLAY),a.on("modeEnter",c.modeEnter,b.REPLAY),a.on("modeExit",c.modeExit,b.REPLAY),a.on("click",c.click,b.REPLAY),a.on("hover",c.hover,b.REPLAY),a.registerMode(b.REPLAY,c)}]).provider("PlayerModeReplay",function(){var a={auto_play_delay:1e3};this.setConfig=function(c){a=b.extend(a,c)},this.$get=["$interval","Player","PlayerModes","PlayerTools","MarkupTypes","GameScorer",function(c,d,e,f,g,h){var i=function(a,b){if(("undefined"==typeof a||"undefined"==typeof b)&&(a=this.mouse.lastX,b=this.mouse.lastY),this.board&&this.board.isOnBoard(a,b))switch(this.tool){case f.MOVE:!this.game.hasStone(a,b)&&this.game.isMoveVariation(a,b)&&this.board.add("hover",a,b,{type:"stones",value:this.game.getTurn()});break;case f.SCORE:this.game.hasStone(a,b)&&this.board.add("hover",a,b,{type:"markup",value:g.MARK})}},j=function(a){for(var b=0;b<a.length;b++)this.board.has("markup",a[b].move.x,a[b].move.y)||this.board.add("markup",a[b].move.x,a[b].move.y,{type:this.board.theme.get("markup.variation.type"),text:this.board.theme.get("markup.variation.text",b),color:this.board.theme.get("markup.variation.color")})},k=function(a){for(var b=0;b<a.length;b++)this.board.remove("markup",a[b].move.x,a[b].move.y)},l=function(a){if(this.board&&this.game&&this.game.isLoaded()){var b,c=this.game.getNode();c&&(this.variationChildren&&c.hasMoveVariations()&&(b=c.getMoveVariations(),a?j.call(this,b):k.call(this,b)),this.variationSiblings&&c.parent&&c.parent.hasMoveVariations()&&(b=c.parent.getMoveVariations(),a?j.call(this,b):k.call(this,b)))}};b.extend(d,{autoPlaying:!1,autoPlayDelay:1e3,autoPlayPromise:null,setAutoPlayDelay:function(a){this.autoPlayDelay!=a&&(this.autoPlayDelay=a,this.broadcast("settingChange","autoPlayDelay"))},start:function(a){if(this.mode==e.REPLAY&&!this.autoPlaying&&this.game&&this.game.node.hasChildren()){var b=this;a="number"==typeof a?a:this.autoPlayDelay,this.switchTool(f.NONE),this.autoPlaying=!0,this.autoPlayPromise=c(function(){b.next(0,!0),b.game.node.hasChildren()||b.stop()},a),this.broadcast("autoPlayStarted",this.game.node)}},stop:function(){this.mode==e.REPLAY&&this.autoPlaying&&(this.autoPlayPromise&&c.cancel(this.autoPlayPromise),this.autoPlayPromise=null,this.autoPlaying=!1,this.broadcast("autoPlayStopped",this.game.node))}});var m={parseConfig:function(c){this.config=b.extend({},this.config,a,c||{}),this.setAutoPlayDelay(this.config.auto_play_delay)},settingChange:function(a,b){"variationMarkup"==b&&l.call(this,this.variationMarkup)},hover:function(){this.board&&(this.board.removeAll("hover"),i.call(this))},boardUpdate:function(){this.variationMarkup&&l.call(this,!0)},click:function(a){if(this.board&&this.board.isOnBoard(a.x,a.y)){switch(this.tool){case f.MOVE:this.game.isMoveVariation(a.x,a.y)&&this.next(this.game.getMoveVariation(a.x,a.y));
break;case f.SCORE:h.mark(a.x,a.y),this.scoreGame()}m.hover.call(this,a)}},pathChange:function(){this.board&&(this.board.removeAll("hover"),i.call(this))},modeEnter:function(){this.setTools([f.MOVE,f.SCORE,f.NONE]),this.tool=this.tools[0],this.variationMarkup&&l.call(this,!0)},modeExit:function(){this.autoPlaying&&this.stop(),this.variationMarkup&&l.call(this,!1)},toolSwitch:function(){this.tool==f.SCORE?(this.statePreScoring=this.board.getState(),h.load(this.game),this.scoreGame()):this.statePreScoring&&(this.board.restoreState(this.statePreScoring),delete this.statePreScoring)}};return m}]}),b.module("ngGo.Player.Mode.Solve.Service",["ngGo"]).run(["Player","PlayerModes","PlayerModeSolve",function(a,b,c){a.on("settingChange",c.settingChange,b.SOLVE),a.on("boardUpdate",c.boardUpdate,b.SOLVE),a.on("pathChange",c.pathChange,b.SOLVE),a.on("modeEnter",c.modeEnter,b.SOLVE),a.on("modeExit",c.modeExit,b.SOLVE),a.on("keydown",c.keyDown,b.SOLVE),a.on("click",c.click,b.SOLVE),a.on("hover",c.hover,b.SOLVE),a.registerMode(b.SOLVE,c)}]).provider("PlayerModeSolve",["StoneColor",function(a){var c={player_color:a.B,solution_paths:!1,solve_auto_play:!0,solve_auto_play_delay:500};this.setConfig=function(a){c=b.extend(c,a)},this.$get=["$timeout","Player","PlayerModes","PlayerTools","KeyCodes",function(a,d,e,f,g){var h=function(){return this.solveAutoPlay?this.problemSolved?!0:this.problemOffPath?!0:this.game.getTurn()==this.playerColor?!0:!1:!0},i=function(a,b){if(("undefined"==typeof a||"undefined"==typeof b)&&(a=this.mouse.lastX,b=this.mouse.lastY),this.board&&this.board.isOnBoard(a,b))switch(this.tool){case f.MOVE:h.call(this)&&this.game.isValidMove(a,b)&&this.board.add("hover",a,b,{type:"stones",value:this.game.getTurn()})}},j=function(a){for(var b=0;b<a.length;b++)a[b].solution===!0?this.board.add("markup",a[b].move.x,a[b].move.y,{type:this.board.theme.get("markup.solution.valid.type"),text:this.board.theme.get("markup.solution.valid.text",b),scale:this.board.theme.get("markup.solution.valid.scale"),color:this.board.theme.get("markup.solution.valid.color")}):this.board.add("markup",a[b].move.x,a[b].move.y,{type:this.board.theme.get("markup.solution.invalid.type"),text:this.board.theme.get("markup.solution.invalid.text",b),scale:this.board.theme.get("markup.solution.invalid.scale"),color:this.board.theme.get("markup.solution.invalid.color")})},k=function(a){for(var b=0;b<a.length;b++)this.board.remove("markup",a[b].move.x,a[b].move.y)},l=function(a){if(this.board&&this.game&&this.game.isLoaded()){var b=this.game.getNode(),c=b.getMoveVariations();return a&&!this.problemSolved&&this.solveAutoPlay&&this.game.getTurn()!=this.playerColor?void k.call(this,c):void(a?j.call(this,c):k.call(this,c))}};b.extend(d,{problemSolved:!1,problemOffPath:!1,problemStartPath:null,playerColor:0,solutionPaths:!1,solveAutoPlay:!0,solveAutoPlayDelay:500,solveNavigationBlocked:!1,setSolveAutoPlay:function(a){this.solveAutoPlay!=a&&(this.solveAutoPlay=a,this.broadcast("settingChange","solveAutoPlay"))},setSolveAutoPlayDelay:function(a){this.solveAutoPlayDelay!=a&&(this.solveAutoPlayDelay=a,this.broadcast("settingChange","solveAutoPlayDelay"))},setPlayerColor:function(a){this.playerColor!=a&&(this.playerColor=a,this.broadcast("settingChange","playerColor"))},getPlayerColor:function(a){return a&&this.board?this.board.colorMultiplier*this.playerColor:this.playerColor},toggleSolutionPaths:function(a){"undefined"==typeof a&&(a=!this.solutionPaths),a!=this.solutionPaths&&(this.solutionPaths=a,this.broadcast("settingChange","solutionPaths"))},autoPlayNext:function(b){if(this.game&&this.game.isLoaded()&&0!==this.game.node.children.length){var c,d=[],e=this;for(c=0;c<this.game.node.children.length;c++)this.game.node.children[c].solution&&d.push(this.game.node.children[c]);if(0===d.length&&(d=this.game.node.children),c=Math.floor(Math.random()*d.length),b||!this.solveAutoPlayDelay)return void this.next(d[c]);this.solveNavigationBlocked=!0,a(function(){e.next(d[c]),e.solveNavigationBlocked=!1},this.solveAutoPlayDelay)}},solve:function(){return this.game&&this.game.isLoaded()?(this.problemSolved=!1,this.problemOffPath=!1,this.problemStartPath=this.game.getPath(!0),this.restrictNode(),void(this.solveAutoPlay&&this.game.getTurn()!=this.playerColor&&this.autoPlayNext())):!1},restartProblem:function(){this.mode==e.SOLVE&&this.game&&this.game.isLoaded()&&(this.problemSolved=!1,this.problemOffPath=!1,this.problemStartPath&&this.goto(this.problemStartPath),this.solveAutoPlay&&this.game.getTurn()!=this.playerColor&&this.autoPlayNext())}});var m={parseConfig:function(a){this.config=b.extend({},this.config,c,a||{}),this.toggleSolutionPaths(this.config.solution_paths),this.setPlayerColor(this.config.player_color),this.setSolveAutoPlay(this.config.solve_auto_play),this.setSolveAutoPlayDelay(this.config.solve_auto_play_delay)},settingChange:function(a,b){"solutionPaths"==b&&l.call(this,this.solutionPaths),"playerColor"==b&&(l.call(this,this.solutionPaths),!this.problemSolved&&this.solveAutoPlay&&this.game.getTurn()!=this.playerColor&&this.autoPlayNext(!0))},hover:function(a){this.board&&(this.board.removeAll("hover"),i.call(this,a.x,a.y))},boardUpdate:function(){this.solutionPaths&&l.call(this,!0)},keyDown:function(a,b){switch(b.keyCode){case g.RIGHT:this.arrowKeysNavigation&&(b.preventDefault(),this.solveNavigationBlocked||this.game.node==this.restrictNodeEnd||this.problemSolved&&this.next());break;case g.LEFT:this.arrowKeysNavigation&&(b.preventDefault(),this.solveNavigationBlocked||this.game.node==this.restrictNodeStart||(this.previous(),!this.problemSolved&&this.solveAutoPlay&&this.game.getTurn()==-this.playerColor&&this.previous()))}},click:function(a){if(this.board&&this.board.isOnBoard(a.x,a.y))if(this.game.isMoveVariation(a.x,a.y)){var b=this.game.getMoveVariation(a.x,a.y);this.next(b);var c=this.game.getNode();0===c.children.length?c.solution===!0?(this.problemSolved=!0,this.broadcast("solutionFound",c)):this.broadcast("solutionWrong",c):!this.problemSolved&&this.solveAutoPlay&&this.autoPlayNext()}else this.game.play(a.x,a.y)&&(this.problemOffPath=!0,this.processPosition(),this.broadcast("solutionOffPath",this.game.getNode()))},pathChange:function(){this.board&&(this.board.removeAll("hover"),i.call(this))},modeEnter:function(){this.setTools([f.MOVE]),this.tool=this.tools[0],this.solutionPaths&&l.call(this,!0)},modeExit:function(){this.solutionPaths&&l.call(this,!1)}};return m}]}]),"undefined"==typeof b.extendDeep&&(b.extendDeep=function(a){for(var c=0;c<arguments.length;c++)if(arguments[c]!=a)for(var d in arguments[c])a[d]&&a[d].constructor&&a[d].constructor===Object?b.extendDeep(a[d],arguments[c][d]):a[d]=b.copy(arguments[c][d]);return a})}(window,window.angular);